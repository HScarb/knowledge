# RocketMQ 消费者（3）重平衡 流程详解 & 源码解析

## 1. 背景

本文是 RocketMQ 消费者系列的第三篇，介绍消费者重平衡。

我把 RocketMQ 消费分成如下几个步骤

1. 重平衡
2. 消费者拉取消息
3. Broker 接收拉取请求后从存储中查询消息并返回
4. 消费者消费消息

其中重平衡是消费者开始消费的起点。

### 1.1 重平衡的含义

RocketMQ 的 Topic 设计成有多个 Queue，被多个消费者同时消费来加快消费速率。

在多个消费者同时消费一个 Topic 时，其中的每个 Queue 只能同时被一个消费者消费。在消费者数量变化时，将  Queue 分配给消费者进行消费的动作即重平衡。

## 2. 概要设计

### 2.1 重平衡的触发

RocketMQ 的重平衡在消费端完成。唯一的触发点是一个重平衡线程，触发方式分主动触发和定时触发。

* 主动触发：消费者数量发生变化
  1. 推模式消费者启动或恢复时，唤醒本地的重平衡线程，立即重平衡。在这之前还上报心跳让 Broker 感知到新消费者启动，发送请求让所有消费者重平衡。
  2. 消费者关机时，向 Broker 发请求解除注册。Broker 收到请求后发送请求让其他消费者重平衡。
* 定时触发：重平衡线程每 20s 触发一次重平衡。

### 2.2 重平衡流程

消费者按 Topic 维度进行重平衡。

1. 从本地缓存中获取 Topic 的所有 Queue
2. 向 Broker 获取所有消费者
3. 按预设的策略将队列分配给消费者
4. 判断自己分配到的队列是否变化
   * 如果变化则丢弃老队列，开始拉取新队列，并将订阅关系上报到 Broker

RocketMQ 的重平衡流程在消费者端完成，但是是由 Broker 端发送信号来触发的。

### 2.3 重平衡类设计

![](../assets/rocketmq-consume-message/rocketmq-consumer-rebalance-class.drawio.png)

### 3. 详细设计

### 4. 源码解析

