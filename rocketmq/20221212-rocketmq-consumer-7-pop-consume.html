<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html"><meta property="og:site_name" content="金甲虫的博客"><meta property="og:title" content="RocketMQ 5.0：POP 消费模式 原理详解 & 源码解析"><meta property="og:description" content="原文地址：http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html (http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html) 1. 背景 1.1 什么..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-17T16:05:07.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2022-12-12T00:00:00.000Z"><meta property="article:modified_time" content="2023-07-17T16:05:07.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ 5.0：POP 消费模式 原理详解 & 源码解析","image":[""],"datePublished":"2022-12-12T00:00:00.000Z","dateModified":"2023-07-17T16:05:07.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>RocketMQ 5.0：POP 消费模式 原理详解 & 源码解析 | 金甲虫的博客</title><meta name="description" content="原文地址：http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html (http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html) 1. 背景 1.1 什么...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-c0752bdb.css" as="style"><link rel="stylesheet" href="/assets/style-c0752bdb.css">
    <link rel="modulepreload" href="/assets/app-eaa093f0.js"><link rel="modulepreload" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-fbcd892c.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-33b1adea.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/index.html-19d3809b.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/index.html-2ffe9047.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-a7ecb646.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-timer.html-3783de8e.js" as="script"><link rel="prefetch" href="/assets/index.html-ccce5c4e.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-ca8df479.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-383d1ff0.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-1b153845.js" as="script"><link rel="prefetch" href="/assets/index.html-fed19b8d.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-40e66472.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-db82fded.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-7a035718.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-4d2cb3a2.js" as="script"><link rel="prefetch" href="/assets/index.html-3f101793.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-dde4ad3c.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-e9d75c4b.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-5e2be81b.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-74b12dbf.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-f5e34f6f.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-c9138520.js" as="script"><link rel="prefetch" href="/assets/index.html-4808fc58.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-93e36349.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-c6a8fa10.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-6cc048ce.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-9e98139f.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-7c41100f.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-88bde295.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-52089ac5.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-9acf57e1.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-51015efc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-abc2abce.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-33271087.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-e0c3f1a1.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-53a87b09.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7be6394f.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-26b85bb0.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-3f5bfad8.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-f0964ee0.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-76d2fb74.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-9f2d304c.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-f7aa5d2e.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-687deffa.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-3d6db503.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-8af4b82f.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-f30f7734.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-fed2f058.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-165a8844.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-263232fe.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-1378ef83.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-f1f5acad.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-timer.html-6a8c6820.js" as="script"><link rel="prefetch" href="/assets/index.html-e5c09f60.js" as="script"><link rel="prefetch" href="/assets/404.html-624a8347.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-3b9185cc.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-1048d6b7.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-e3494be4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="金甲虫的博客"><!----><span class="vp-site-name hide-in-pad">金甲虫的博客</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="掘金" class="nav-link"><!---->掘金<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ 5.0：POP 消费模式 原理详解 &amp; 源码解析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-背景">1. 背景</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-1-什么是-pop-消费">1.1 什么是 Pop 消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-2-如何使用-pop-消费">1.2 如何使用 Pop 消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-3-引入-pop-消费模式的原因">1.3 引入 Pop 消费模式的原因</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-概要设计">2. 概要设计</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-pop-消费流程">2.1 Pop 消费流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-客户端-服务端交互">2.2 客户端-服务端交互</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-3-服务端实现">2.3 服务端实现</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_3-详细设计">3. 详细设计</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-1-broker-端重平衡">3.1 Broker 端重平衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-2-broker-端-pop-消息">3.2 Broker 端 Pop 消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-3-broker-端-ack-消息">3.3 Broker 端 ACK 消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-4-broker-端-checkpoint-与-ackmsg-匹配">3.4 Broker 端 CheckPoint 与 AckMsg 匹配</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_4-源码解析">4. 源码解析</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-1-broker-端重平衡">4.1 Broker 端重平衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-2-broker-端-pop-消息">4.2 Broker 端 Pop 消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-3-broker-端-ack-消息">4.3 Broker 端 Ack 消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-4-broker-端-checkpoint-与-ackmsg-匹配">4.4 Broker 端 CheckPoint 与 AckMsg 匹配</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#参考资料">参考资料</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>原文地址：<a href="http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-5-0-pop-消费模式-原理详解-源码解析" tabindex="-1"><a class="header-anchor" href="#rocketmq-5-0-pop-消费模式-原理详解-源码解析" aria-hidden="true">#</a> RocketMQ 5.0：POP 消费模式 原理详解 &amp; 源码解析</h1><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h2><h3 id="_1-1-什么是-pop-消费" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是-pop-消费" aria-hidden="true">#</a> 1.1 什么是 Pop 消费</h3><p>RocketMQ 5.0 中引入了一种新的消费模式：Pop 消费模式。</p><p>我们知道 RocketMQ 原来有两种消费模式：Pull 模式消费和 Push 模式消费，其中 Push 模式指的是 Broker 将消息主动“推送”给消费者，它的背后其实是消费者在不断地 Pull 消息来实现类似于 Broker “推”消息给消费者的效果。</p><p>新引入的 Pop 消费模式主要是用于 Push 消费时将拉消息的动作替换成 Pop 。Pop 消费的行为和 Pull 消费很像，区别在于 Pop 消费的重平衡是在 Broker 端做的，而之前的 Pull 和 Push 消费都是由客户端完成重平衡。</p><h3 id="_1-2-如何使用-pop-消费" tabindex="-1"><a class="header-anchor" href="#_1-2-如何使用-pop-消费" aria-hidden="true">#</a> 1.2 如何使用 Pop 消费</h3><p>RocketMQ 提供了 2 种方式，能够让 Push 消费切换为使用 Pop 模式拉取消息（Pull 消费暂不支持切换 Pop 模式），分别为命令行方式切换和客户端代码方式切换。</p><h4 id="_1-2-1-使用命令行方式切换" tabindex="-1"><a class="header-anchor" href="#_1-2-1-使用命令行方式切换" aria-hidden="true">#</a> 1.2.1 使用命令行方式切换</h4><p>利用命令行，用如下命令，指定集群和需要切换的消费组，可以将一个消费组切换成 Pop 消费模式消费某个 Topic</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mqadmin setConsumeMode <span class="token parameter variable">-c</span> cluster <span class="token parameter variable">-t</span> topic <span class="token parameter variable">-g</span> group <span class="token parameter variable">-m</span> POP <span class="token parameter variable">-q</span> <span class="token number">8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>以下为参数含义，其中 <code>popShareQueueNum</code> 表示 1 个队列最多可以被 N 个消费者同时消费。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;clusterName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;create subscription group to which cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;topicName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;topic name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;groupName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;consumer group name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mode&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;consume mode. PULL/POP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;q&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;popShareQueueNum&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;num of queue which share in pop mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-代码切换" tabindex="-1"><a class="header-anchor" href="#_1-2-2-代码切换" aria-hidden="true">#</a> 1.2.2 代码切换</h4><p>在创建 Consumer 之前，先运行 <code>switchPop()</code> 方法，它其实与上面命令行的逻辑一样，也是发送请求给集群中的所有 Broker 节点，让它们切换对应消费者组和 Topic 的消费者的消费模式为 Pop 模式。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// PopPushConsumer.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PopPushConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONSUMER_GROUP</span> <span class="token operator">=</span> <span class="token string">&quot;CID_JODIE_1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC</span> <span class="token operator">=</span> <span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// Or use AdminTools directly: mqadmin setConsumeMode -c cluster -t topic -g group -m POP -n 8</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">switchPop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultMQAdminExt</span> mqAdminExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQAdminExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mqAdminExt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ClusterInfo</span> clusterInfo <span class="token operator">=</span> mqAdminExt<span class="token punctuation">.</span><span class="token function">examineBrokerClusterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brokerAddrs <span class="token operator">=</span> clusterInfo<span class="token punctuation">.</span><span class="token function">getBrokerAddrTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">BrokerData</span><span class="token operator">::</span><span class="token function">selectBrokerAddr</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> brokerAddr <span class="token operator">:</span> brokerAddrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mqAdminExt<span class="token punctuation">.</span><span class="token function">setMessageRequestMode</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> <span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">,</span> <span class="token class-name">MessageRequestMode</span><span class="token punctuation">.</span><span class="token constant">POP</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">switchPop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_LAST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setClientRebalance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer Started.%n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-引入-pop-消费模式的原因" tabindex="-1"><a class="header-anchor" href="#_1-3-引入-pop-消费模式的原因" aria-hidden="true">#</a> 1.3 引入 Pop 消费模式的原因</h3><p>引入 Pop 消费主要的原因是由于 Push 消费的机制导致它存在一些痛点。RocketMQ 5.0 云原生化的要求催生着一种能够解决这些痛点的新消费模式诞生。</p><p>Push 消费模式的重平衡逻辑是在客户端完成的，这就导致了几个问题：</p><ol><li>客户端代码逻辑较重，要支持一种新语言的客户端就必须实现完整的重平衡逻辑，此外还需要实现拉消息、位点管理、消费失败后将消息发回 Broker 重试等逻辑。这给多语言客户端的支持造成很大的阻碍。</li><li>当客户端升级或者下线时，都要进行重平衡操作，可能造成消息堆积。</li></ol><p>此外，Push 消费的特性是重平衡后每个消费者都分配到消费一定数量的队列，而每个队列最多只能被一个消费者消费。这就决定了消费者的横向扩展能力受到 Topic 中队列数量的限制。这里有引入了如下痛点</p><ol><li>消费者无法无限扩展，当消费者数量扩大到大于队列数量时，有的消费者将无法分配到队列。</li><li>当某些消费者僵死（hang 住）时（与 Broker 的心跳未断，但是无法消费消息），会造成其消费的队列的消息堆积，迟迟无法被消费，也不会主动重平衡来解决这个问题。</li></ol><hr><p>引入 Pop 消费模式之后，可以解决 Push 消费导致的可能的消息堆积问题和横向扩展能力问题。此外，RocketMQ 5.0 中引入了的轻量化客户端就用到了 Pop 消费能力，将 Pop 消费接口用 gRPC 封装，实现了多语言轻量化客户端，而不必在客户端实现重平衡逻辑。详见该项目 <a href="https://github.com/apache/rocketmq-clients" target="_blank" rel="noopener noreferrer">rocketmq-clients<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><h2 id="_2-概要设计" tabindex="-1"><a class="header-anchor" href="#_2-概要设计" aria-hidden="true">#</a> 2. 概要设计</h2><p>Pop 消费主要的设计思想是将繁重的客户端逻辑如重平衡、消费进度提交、消费失败后发到 Broker 重试等逻辑放到 Broker 端。</p><p>客户端只需要不断发送 Pop 请求，由 Broker 端来分配每次拉取请求要拉取的队列并返回消息。这样就可以实现多个客户端同时拉取一个队列的效果，不会存在一个客户端 hang 住导致队列消息堆积，也不会存在频繁的重平衡导致消息积压。</p><h3 id="_2-1-pop-消费流程" tabindex="-1"><a class="header-anchor" href="#_2-1-pop-消费流程" aria-hidden="true">#</a> 2.1 Pop 消费流程</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130012457.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>为了保证消费速度，Pop 消费一次请求可以拉取一批消息，拉取到的消息系统属性中有一个比较重要的属性叫做 <code>POP_CK</code>，它是该消息的句柄，ACK 时要通过句柄来定位到它。在 Broker 端会为这批消息保存一个 <code>CheckPoint</code>，它里面包含一批消息的句柄信息。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130025660.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>对于长时间没有 ACK 的消息，Broker 端并非毫无办法。Pop 消费引入了消息不可见时间（invisibleTime）的机制。当 Pop 出一条消息后，这条消息对所有消费者不可见，即进入不可见时间，当它超过该时刻还没有被 ACK，Broker 将会把它放入 Pop 专门的重试 Topic（这个过程称为 Revive），这条消息重新可以被消费。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130013463.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Push 消费的重试间隔时间会随着重试次数而增加，Pop 消费也沿用了这个设计。此外，Pop 消费提供了一个接口 <code>changeInvisibleTime()</code> 来修改单条消息的不可见时间。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130025555.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>从图上可以看见，本来消息会在中间这个时间点再一次的可见的，但是我们在可见之前提前使用 <code>changeInvisibleTime</code> 延长了不可见时间，让这条消息的可见时间推迟了。</p><p>当消费失败（用户业务代码返回 reconsumeLater 或者抛异常）的时候，消费者就通过 <code>changeInvisibleTime</code> 按照重试次数来修改下一次的可见时间。另外如果消费消息用时超过了 30 秒（默认值，可以修改），则 Broker 也会把消息放到重试队列。</p><h3 id="_2-2-客户端-服务端交互" tabindex="-1"><a class="header-anchor" href="#_2-2-客户端-服务端交互" aria-hidden="true">#</a> 2.2 客户端-服务端交互</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626388.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Pop 消费的流程与 Push 消费较为相似，这里我分为 5 个步骤。</p><ol><li>向 Broker 端发送请求，切换消息拉取模式为 Pop 模式</li><li>重平衡服务执行重平衡，此时已经切换为 Pop 模式，所以是向 Broker 端发起请求，请求中带有重平衡策略，Broker 会返回重平衡的结果。</li><li>重平衡完毕之后开始拉取消息，拉取消息服务发送 <code>POP_MESSAGE</code> 请求给 Broker，获取一批消息</li><li>消费这批消息</li><li>对成功消费的消息，发送 ACK 请求给 Broker</li></ol><h3 id="_2-3-服务端实现" tabindex="-1"><a class="header-anchor" href="#_2-3-服务端实现" aria-hidden="true">#</a> 2.3 服务端实现</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130042984.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>服务端收到 Pop 请求后，会先在 Queue 维度上加锁，保证同一时间只有一个消费者可以拉取该队列的消息。</p><p>随后服务端会在存储中查询一批消息，将这批消息的构建的 <code>CheckPoint</code> 保存在 Broker 中，以便与 ACK 的消息匹配。</p><p><code>CheckPoint</code> 的存在目的是与 ACK 的消息匹配，并将没有匹配的消息重试。<code>CheckPoint</code> 的 <code>ReviveTime</code> 就是它这批消息需要被尝试重试（唤醒）的时间。</p><p><code>CheckPoint</code>会先被保存在内存中，一般来说消息消费很快，所以在内存中就能够与 ACK 消息匹配成功后删除。如果在一段时间（默认 3s）内没有匹配成功，它将会从内存中被删除，转入磁盘等待匹配。</p><p>对于 ACK 消息也一样，它先被放入内存中匹配，如果在内存中找不到对应的 <code>CheckPoint</code>，也会放入磁盘。</p><hr><p>RocketMQ 的磁盘存储实际上就是 Topic 和队列。为了避免频繁检查匹配状态，我们只在 <code>CheckPoint</code> 需要被唤醒时做检查，这里就可以用到定时消息，将 <code>CheckPoint</code> 和 ACK 消息定时到 <code>ReviveTime</code> 投递。这里 RocketMQ 将 <code>CheckPoint</code> 的投递时间提前 1s，以便能先消费到，与 ACK 消息匹配。</p><p>当定时到期，它们会被投递到 <code>REVIVE_TOPIC</code>。有个后台线程消费这个 Topic，把 <code>CheckPoint</code> 放到一个 map 中，对于 ACK 消息则从 map 中查找 <code>CheckPoint</code> 来尝试匹配，如果匹配成功则更新 <code>REVIVE_TOPIC</code> 的消费位点。对于超过 <code>ReviveTime</code> 还没有被匹配的 <code>CheckPoint</code>，查出这批消息中要重试消息对应的真实消息，并放到 Pop 消费重试 Topic 中。</p><p>Broker 端的 Pop 消费逻辑会概率性消费到重试 Topic 中的消息。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130045464.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_3-详细设计" tabindex="-1"><a class="header-anchor" href="#_3-详细设计" aria-hidden="true">#</a> 3. 详细设计</h2><h3 id="_3-1-broker-端重平衡" tabindex="-1"><a class="header-anchor" href="#_3-1-broker-端重平衡" aria-hidden="true">#</a> 3.1 Broker 端重平衡</h3><p>Pop 消费的重平衡在 Broker 端完成，客户端的重平衡服务重平衡时会向 Broker 端发送查询请求，查询自己的分配结果。</p><p>重平衡的主要逻辑其实与在客户端重平衡类似，只不过变成了 Broker 接收客户端的参数之后根据这些参数进行重平衡，然后把重平衡结果返回给客户端。</p><p>Broker 端重平衡入口为 <code>QueryAssignmentProcessor#doLoadBalance()</code>。</p><p>对于广播模式，直接返回 Topic 下所有的队列。</p><p>对于集群模式，Pop 模式的重平衡与 Push 模式不同，它允许一个队列被多个消费者 Pop 消费。在切换 Pop 模式时引入了 <code>popShareQueueNum</code> 参数，表示允许消费者进行额外的负载获取队列的次数（可以被共享的队列数），0 表示可以消费所有队列。</p><p>所以重平衡时对每个消费者执行 <code>popShareQueueNum</code> 次重平衡策略，将多次重平衡分配到的队列都分给这个消费者消费。这样，每个队列就会被多个消费者消费。</p><p>下图为 <code>popShareQueueNum = 1</code> 时的重平衡情况，每个消费者被负载了 2 次，每个队列被 2 个消费者共享（1 + <code>popShareQueueNum</code>）。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626711.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-2-broker-端-pop-消息" tabindex="-1"><a class="header-anchor" href="#_3-2-broker-端-pop-消息" aria-hidden="true">#</a> 3.2 Broker 端 Pop 消息</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626730.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-2-1-请求处理入口" tabindex="-1"><a class="header-anchor" href="#_3-2-1-请求处理入口" aria-hidden="true">#</a> 3.2.1 请求处理入口</h4><p>Pop 消息的 Broker 端处理是由 <code>PopMessageProcessor#processRequest()</code> 完成。</p><p>该方法逻辑为</p><ol><li>完成请求体解析和一些参数和权限的校验</li><li>生成一个 0 到 99 的随机整数，如果能被 5 整除，则先拉取重试 Topic。</li><li>从重试 Topic 的每个 Queue 中 Pop 消息</li><li>根据请求的队列 Pop 对应的队列的消息。如果 Pop 请求指定了队列，只会消费一个队列的消息；如果没有指定队列，则 Pop 所有队列的消息</li><li>如果 Pop 的消息没有满（达到请求的最大消息数量），且之前没有拉取过重试消息，则 Pop 重试 Topic 所有队列的消息（期望填充满 Pop 请求要求的数量）</li><li>判断是否 Pop 到消息，如果有则传输回客户端，如果没有则挂起轮询，直到超过请求的 timeout 参数指定的时间</li></ol><h4 id="_3-2-2-pop-消息方法" tabindex="-1"><a class="header-anchor" href="#_3-2-2-pop-消息方法" aria-hidden="true">#</a> 3.2.2 Pop 消息方法</h4><p>上面的 3、4、5 都涉及到从存储中 Pop 消息，它们都调用同一个方法：<code>popMsgFromQueue</code>，它是真正查询消息的方法，下面看一下它的逻辑</p><ol><li>将需要 Pop 的队列上锁（用 <code>AtomicBoolean</code> 实现）</li><li>计算 Pop 消息的起始偏移量，会返回内存中 CheckPoint 与 ACK 消息匹配后的最新位点</li><li>从磁盘中根据起始偏移量查询一批消息</li><li>计算队列剩余的消息数量（用作返回值）</li><li>拉取的这批消息将生成一个 <code>CheckPoint</code>，存入内存和磁盘</li><li>解锁队列</li><li>返回 Pop 到的消息</li></ol><p>上面方法第 5 步会将生成的 <code>CheckPoint</code> 放入内存和磁盘，注意这个 <code>CheckPoint</code> 会保存一批获取到的消息的起始偏移量和相对偏移量（相对于起始偏移量），所以一个 <code>CheckPoint</code> 在保存和匹配时都对应一批消息。</p><h4 id="_3-2-3-保存-checkpoint-用于匹配" tabindex="-1"><a class="header-anchor" href="#_3-2-3-保存-checkpoint-用于匹配" aria-hidden="true">#</a> 3.2.3 保存 <code>CheckPoint</code> 用于匹配</h4><ol><li>构造 <code>CheckPoint</code>，添加起始偏移量和所有 Pop 出的消息的相对偏移量</li><li>尝试将 <code>CheckPoint</code> 添加到内存 Buffer，如果成功则直接返回。但是在内存中匹配 <code>CheckPoint</code> 和 <code>AckMsg</code> 的开关默认是关闭的，所以这里不会加入到内存，会继续后面的逻辑放入磁盘</li><li>将 <code>CheckPoint</code> 构造成一个消息，数据都放到消息体中，然后这个消息定时到 <code>ReviveTime</code>（唤醒重试的时间）- 1s（为了留时间与 <code>AckMsg</code> 匹配）发送。会发送到 ReviveTopic 的一个队列。</li></ol><h3 id="_3-3-broker-端-ack-消息" tabindex="-1"><a class="header-anchor" href="#_3-3-broker-端-ack-消息" aria-hidden="true">#</a> 3.3 Broker 端 ACK 消息</h3><p>Ack 消息接口每次只允许 Ack 一条消息，入口是 <code>AckMessageProcessor#processRequest()</code></p><ol><li>从请求头解析和构造 Ack 消息，并作一些校验</li><li>顺序消息 Ack 和普通消息 Ack 分别处理，这里针对普通消息</li><li>先尝试将 Ack 消息放入内存 Buffer，如果成功则直接返回。失败则有可能是内存匹配未开启。</li><li>如果放入内存失败，构造一个用于存到磁盘的消息，定时到唤醒重试时间投递（到 ReviveTopic）。</li></ol><h3 id="_3-4-broker-端-checkpoint-与-ackmsg-匹配" tabindex="-1"><a class="header-anchor" href="#_3-4-broker-端-checkpoint-与-ackmsg-匹配" aria-hidden="true">#</a> 3.4 Broker 端 <code>CheckPoint</code> 与 <code>AckMsg</code> 匹配</h3><p><code>CheckPoint</code> 和 <code>AckMsg</code> 都被设计成先尝试放入内存中匹配，然后再磁盘中匹配，因为通常情况下消息消费之后都能很快 ACK，内存匹配性能较高。如果 <code>CheckPoint</code> 在内存中停留太久没有被匹配，则会转移到磁盘中（ReviveTopic），有个线程消费这个 ReviveTopic 来匹配。到达唤醒重试时间（ReviveTime）还没有被匹配的 <code>CheckPoint</code> 里面的消息将会重试（发送到 Pop 消息重试 Topic，后面的 Pop 有概率消费到）。</p><h4 id="_3-4-1-内存匹配" tabindex="-1"><a class="header-anchor" href="#_3-4-1-内存匹配" aria-hidden="true">#</a> 3.4.1 内存匹配</h4><p>内存匹配逻辑由一个线程 <code>PopBufferMergeService</code> 完成，只有主节点运行该匹配线程。</p><p>Pop 消息时会先添加 <code>CheckPoint</code> 到 buffer，Ack 消息时尝试从内存 buffer 中的 <code>CheckPoint</code> 匹配。同时，它每 5ms 执行一次扫描，将不符合内存中存活条件的 <code>CheckPoint</code> 移除，放入磁盘存储。</p><p><code>addCk</code> 方法将 <code>CheckPoint</code> 放入内存 Buffer。<code>CheckPoint</code> 中有一个码表 <code>BitMap</code>，用来表示它里面的每个条消息是否被 Ack 和被存到磁盘。用 <code>BitMap</code> 可以加速匹配。</p><p><code>addAk</code> 方法会尝试从 buffer 中找 <code>CheckPoint</code> 来匹配。如果找到对应的 <code>CheckPoint</code>，则修改它码表的对应位，表示这条消息被 ACK。</p><p><code>scan</code> 方法每 5ms 执行一次</p><ol><li>将已经匹配或存盘的 <code>CheckPoint</code> 移出 buffer</li><li>把超时的 <code>CheckPoint</code> 存入磁盘</li><li>对于匹配完成或者存盘的 <code>CheckPoint</code>，为他们提交消息偏移量</li></ol><h4 id="_3-4-2-store-匹配和消息重试" tabindex="-1"><a class="header-anchor" href="#_3-4-2-store-匹配和消息重试" aria-hidden="true">#</a> 3.4.2 Store 匹配和消息重试</h4><p>从内存中移除保存到磁盘的 <code>CheckPoint</code> 和 <code>AckMsg</code> 都会封装成消息进行定时投递（定时到重试时间），最终投递到 <code>ReviveTopic</code>。存储中匹配也由一个线程 <code>PopReviveService</code> 完成，它消费 <code>ReviveTopic</code> 的消息进行匹配和重试。</p><p>Pop 消费由于要根据 Topic 来 Pop 消息，重试 Topic 需要针对每个 [消费组-Topic] 隔离，所以它不能用普通消息的消费组维度的重试 Topic，而是用专门的 Pop 重试 Topic <code>%RETRY%{消费组}_{TOPIC}</code>。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626776.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>PopReviveService#run</code> 方法是该处理线程的入口，它每秒都会调用 <code>consumeReviveMessage</code> 消费和匹配 ReviveTopic 消息，然后调用 <code>mergeAndRevive</code> 方法检查匹配的情况并对达到唤醒时间还没有成功匹配的消息重试。</p><p>这两个方法会先初始化一个 map，用于存放 <code>CheckPoint</code>，供 <code>AckMsg</code> 根据 map key 查找 <code>CheckPoint</code>。</p><hr><p><code>consumeReviveMessage</code> 会消费 2s 内的一批 ReviveTopic 消息，CK 消息放入 map，Ack 消息则从 map 中查找 CK，在码表上标记对应的消息为 Acked。</p><p><code>mergeAndRevive</code> 方法如其名，遍历消费到的 CK 消息，对于已经到重试时间的，对没有 Ack 的消息进行重试。</p><p>重试逻辑为先从 MessageStore 查询对应的真正消息，然后将该消息发送到 Pop 重试队列。</p><h2 id="_4-源码解析" tabindex="-1"><a class="header-anchor" href="#_4-源码解析" aria-hidden="true">#</a> 4. 源码解析</h2><h3 id="_4-1-broker-端重平衡" tabindex="-1"><a class="header-anchor" href="#_4-1-broker-端重平衡" aria-hidden="true">#</a> 4.1 Broker 端重平衡</h3><h4 id="_4-1-1-queryassignmentprocessor-doloadbalance" tabindex="-1"><a class="header-anchor" href="#_4-1-1-queryassignmentprocessor-doloadbalance" aria-hidden="true">#</a> 4.1.1 <code>QueryAssignmentProcessor#doLoadBalance</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Broker 端重平衡
 * Returns empty set means the client should clear all load assigned to it before, null means invalid result and the
 * client should skip the update logic
 *
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span>
 * <span class="token keyword">@param</span> <span class="token parameter">consumerGroup</span>
 * <span class="token keyword">@param</span> <span class="token parameter">clientId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">messageModel</span> 消费模型（广播/集群）
 * <span class="token keyword">@param</span> <span class="token parameter">strategyName</span> 重平衡策略名
 * <span class="token keyword">@return</span> the MessageQueues assigned to this client
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token function">doLoadBalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clientId<span class="token punctuation">,</span>
                                        <span class="token keyword">final</span> <span class="token class-name">MessageModel</span> messageModel<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> strategyName<span class="token punctuation">,</span>
                                        <span class="token class-name">SetMessageRequestModeRequestBody</span> setMessageRequestModeRequestBody<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> assignedQueueSet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">TopicRouteInfoManager</span> topicRouteInfoManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 广播模式，返回该 Topic 下所有队列</span>
            assignedQueueSet <span class="token operator">=</span> topicRouteInfoManager<span class="token punctuation">.</span><span class="token function">getTopicSubscribeInfo</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>assignedQueueSet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}], the topic[{}] does not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 集群模式</span>
            <span class="token comment">// 获取 Topic 下所有队列</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqSet <span class="token operator">=</span> topicRouteInfoManager<span class="token punctuation">.</span><span class="token function">getTopicSubscribeInfo</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}], the topic[{}] does not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isServerLoadBalancerEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mqSet<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取发起请求的消费组信息</span>
            <span class="token class-name">ConsumerGroupInfo</span> consumerGroupInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumerGroupInfo</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerGroupInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cidAll <span class="token operator">=</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">getAllClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}] topic[{}], get consumer id list failed&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将队列和消费者客户端ID 排序</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 根据重平衡策略名称获取策略</span>
                <span class="token class-name">AllocateMessageQueueStrategy</span> allocateMessageQueueStrategy <span class="token operator">=</span> name2LoadStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> allocateMessageQueueStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: unsupported strategy [{}],  {}&quot;</span><span class="token punctuation">,</span> strategyName<span class="token punctuation">,</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>setMessageRequestModeRequestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> setMessageRequestModeRequestBody<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MessageRequestMode</span><span class="token punctuation">.</span><span class="token constant">POP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// POP 模式重平衡</span>
                    allocateResult <span class="token operator">=</span> <span class="token function">allocate4Pop</span><span class="token punctuation">(</span>allocateMessageQueueStrategy<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span>
                                                  cidAll<span class="token punctuation">,</span> setMessageRequestModeRequestBody<span class="token punctuation">.</span><span class="token function">getPopShareQueueNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 普通重平衡</span>
                    allocateResult <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}] topic[{}], allocate message queue exception. strategy name: {}, ex: {}&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> strategyName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            assignedQueueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                assignedQueueSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> assignedQueueSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-2-queryassignmentprocessor-allocate4pop" tabindex="-1"><a class="header-anchor" href="#_4-1-2-queryassignmentprocessor-allocate4pop" aria-hidden="true">#</a> 4.1.2 <code>QueryAssignmentProcessor#allocate4Pop</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * POP 模式重平衡
 *
 * <span class="token keyword">@param</span> <span class="token parameter">allocateMessageQueueStrategy</span> 重平衡策略
 * <span class="token keyword">@param</span> <span class="token parameter">consumerGroup</span> 消费组
 * <span class="token keyword">@param</span> <span class="token parameter">clientId</span> 消费组客户端 ID
 * <span class="token keyword">@param</span> <span class="token parameter">mqAll</span> 全部消息队列
 * <span class="token keyword">@param</span> <span class="token parameter">cidAll</span> 全部客户端ID
 * <span class="token keyword">@param</span> <span class="token parameter">popShareQueueNum</span> Pop 模式下可允许被共享的队列数，0 表示无限
 * <span class="token keyword">@return</span> 该消费者负载的队列列表
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token function">allocate4Pop</span><span class="token punctuation">(</span><span class="token class-name">AllocateMessageQueueStrategy</span> allocateMessageQueueStrategy<span class="token punctuation">,</span>
                                       <span class="token keyword">final</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clientId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> popShareQueueNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>popShareQueueNum <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> popShareQueueNum <span class="token operator">&gt;=</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每个消费者能消费所有队列，返回全部队列。队列 ID 为 -1 表示 Pop 消费时消费全部队列</span>
        <span class="token comment">//each client pop all messagequeue</span>
        allocateResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> mq <span class="token operator">:</span> mqAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//must create new MessageQueue in case of change cache in AssignmentManager</span>
            <span class="token class-name">MessageQueue</span> newMq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocateResult<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newMq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 消费者数量小于等于队列数量，每个消费者分配 N 个队列，每个队列也会被分配给多个消费者</span>
            <span class="token comment">//consumer working in pop mode could share the MessageQueues assigned to the N (N = popWorkGroupSize) consumer following it in the cid list</span>
            allocateResult <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> cidAll<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 负载 popShareQueueNum 次，将每次负载的结果加入最终结果</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> popShareQueueNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    index<span class="token operator">++</span><span class="token punctuation">;</span>
                    index <span class="token operator">=</span> index <span class="token operator">%</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> tmp <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> cidAll<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allocateResult<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 消费者数量大于队列数量，保证每个消费者都有队列消费</span>
            <span class="token comment">//make sure each cid is assigned</span>
            allocateResult <span class="token operator">=</span> <span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> allocateResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-broker-端-pop-消息" tabindex="-1"><a class="header-anchor" href="#_4-2-broker-端-pop-消息" aria-hidden="true">#</a> 4.2 Broker 端 Pop 消息</h3><h4 id="_4-2-1-popmessageprocessor-processrequest" tabindex="-1"><a class="header-anchor" href="#_4-2-1-popmessageprocessor-processrequest" aria-hidden="true">#</a> 4.2.1 <code>PopMessageProcessor#processRequest</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 处理 POP 消息请求
 *
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">RemotingCommandException</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... 解析请求体和一系列校验</span>

    <span class="token comment">// 生成随机数</span>
    <span class="token keyword">int</span> randomQ <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> reviveQid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reviveQid <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token constant">POP_ORDER_REVIVE_QUEUE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 轮询选一个 Revive 队列</span>
        reviveQid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>ckMessageNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReviveQueueNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> commercialSizePerMsg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommercialSizePerMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetMessageResult</span> getMessageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMessageResult</span><span class="token punctuation">(</span>commercialSizePerMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 队列中剩余的消息数量</span>
    <span class="token keyword">long</span> restNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 1/5 的概率拉取重试消息</span>
    <span class="token keyword">boolean</span> needRetry <span class="token operator">=</span> randomQ <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> popTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拉取重试消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needRetry <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopicConfig</span> retryTopicConfig <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTopicConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span>
                                          channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                          startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果拉取请求没有指定队列（-1），则拉取所有队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// read all queue</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                      startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拉取请求指定了队列，拉取对应的队列</span>
        <span class="token keyword">int</span> queueId <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> channel<span class="token punctuation">,</span>
                                  popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                  startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果前面拉取普通消息之后，没有满，则再拉取一次重试消息</span>
    <span class="token comment">// if not full , fetch retry again</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needRetry <span class="token operator">&amp;&amp;</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopicConfig</span> retryTopicConfig <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTopicConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span>
                                          channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                          startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 拉取消息成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageBufferList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        getMessageResult<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>restNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// all queue pop can not notify specified queue pop, and vice versa</span>
            <span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有拉取到消息，长轮询</span>
        <span class="token keyword">int</span> pollingResult <span class="token operator">=</span> <span class="token function">polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> request<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">POLLING_SUC</span> <span class="token operator">==</span> pollingResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">POLLING_FULL</span> <span class="token operator">==</span> pollingResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">POLLING_FULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">POLLING_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        getMessageResult<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MESSAGE_IN_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setInvisibleTime</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setPopTime</span><span class="token punctuation">(</span>popTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setReviveQid</span><span class="token punctuation">(</span>reviveQid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setRestNum</span><span class="token punctuation">(</span>restNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setStartOffsetInfo</span><span class="token punctuation">(</span>startOffsetInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setMsgOffsetInfo</span><span class="token punctuation">(</span>msgOffsetInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> orderCountInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        responseHeader<span class="token punctuation">.</span><span class="token function">setOrderCountInfo</span><span class="token punctuation">(</span>orderCountInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 传输消息</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-popmessageprocessor-popmsgfromqueue" tabindex="-1"><a class="header-anchor" href="#_4-2-2-popmessageprocessor-popmsgfromqueue" aria-hidden="true">#</a> 4.2.2 <code>PopMessageProcessor#popMsgFromQueue</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 从消息队列中 POP 消息
 *
 * <span class="token keyword">@param</span> <span class="token parameter">isRetry</span> 是否是重试 Topic
 * <span class="token keyword">@param</span> <span class="token parameter">getMessageResult</span>
 * <span class="token keyword">@param</span> <span class="token parameter">requestHeader</span>
 * <span class="token keyword">@param</span> <span class="token parameter">queueId</span> 消息队列 ID
 * <span class="token keyword">@param</span> <span class="token parameter">restNum</span> 队列剩余消息数量
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span> 唤醒队列 ID
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span> Netty Channel，用于获取客户端 host，来提交消费进度
 * <span class="token keyword">@param</span> <span class="token parameter">popTime</span> Pop 时间
 * <span class="token keyword">@param</span> <span class="token parameter">messageFilter</span>
 * <span class="token keyword">@param</span> <span class="token parameter">startOffsetInfo</span> 获取 Pop 的起始偏移量
 * <span class="token keyword">@param</span> <span class="token parameter">msgOffsetInfo</span> 获取所有 Pop 的消息的逻辑偏移量
 * <span class="token keyword">@param</span> <span class="token parameter">orderCountInfo</span>
 * <span class="token keyword">@return</span> 队列剩余消息
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isRetry<span class="token punctuation">,</span> <span class="token class-name">GetMessageResult</span> getMessageResult<span class="token punctuation">,</span>
                             <span class="token class-name">PopMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">long</span> restNum<span class="token punctuation">,</span> <span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span>
                             <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token keyword">long</span> popTime<span class="token punctuation">,</span>
                             <span class="token class-name">ExpressionMessageFilter</span> messageFilter<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> startOffsetInfo<span class="token punctuation">,</span>
                             <span class="token class-name">StringBuilder</span> msgOffsetInfo<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> orderCountInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> topic <span class="token operator">=</span> isRetry <span class="token operator">?</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                           requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// {TOPIC}@{GROUP}@{QUEUE_ID}</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span>
        topic <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SPLIT</span> <span class="token operator">+</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SPLIT</span> <span class="token operator">+</span> queueId<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isOrder <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">getPopOffset</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Queue 上加锁，保证同一时刻只有一个消费者可以拉取同一个 Queue 的消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queueLockManager<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回该队列中待 Pop 的消息数量</span>
        restNum <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 计算要 POP 的消息偏移量</span>
    offset <span class="token operator">=</span> <span class="token function">getPopOffset</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetMessageResult</span> getMessageTmpResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 顺序消费，阻塞</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isOrder <span class="token operator">&amp;&amp;</span> brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOrderInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkBlock</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>
                                                                                 requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 已经拉取到足够的消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            restNum <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
            <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从磁盘消息存储中根据逻辑偏移量查询消息</span>
        getMessageTmpResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                 <span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                                                                 requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageTmpResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// maybe store offset is not correct.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_TOO_SMALL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// commit offset, because the offset is not correct</span>
            <span class="token comment">// If offset in store is greater than cq offset, it will cause duplicate messages,</span>
            <span class="token comment">// because offset in PopBuffer is not committed.</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Pop initial offset, because store is no correct, {}, {}-&gt;{}&quot;</span><span class="token punctuation">,</span>
                            lockKey<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            getMessageTmpResult <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                   queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                                                   requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 计算队列还剩下的消息数量</span>
        restNum <span class="token operator">=</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新统计数据</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBrokerGetNums</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupGetNums</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupGetSize</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 顺序消费，更新偏移量</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOrderInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>
                                                                                  requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                  queueId<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                              requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildOrderCountInfo</span><span class="token punctuation">(</span>orderCountInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加 CheckPoint 到内存，用于等待 ACK</span>
                <span class="token function">appendCheckPoint</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildStartOffsetInfo</span><span class="token punctuation">(</span>startOffsetInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildMsgOffsetInfo</span><span class="token punctuation">(</span>msgOffsetInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span>
                                             getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_WAS_REMOVING</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_LOGIC_QUEUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token operator">&amp;&amp;</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 没有拉取到消息，添加假的消息 CheckPoint 到队列</span>
            popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCkMock</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                            requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//                this.brokerController.getConsumerOffsetManager().commitOffset(channel.remoteAddress().toString(), requestHeader.getConsumerGroup(), topic,</span>
            <span class="token comment">//                        queueId, getMessageTmpResult.getNextBeginOffset());</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in popMsgFromQueue&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// Pop 完后解锁</span>
        queueLockManager<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将拉取到的消息放入结果容器中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageTmpResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectMappedBufferResult</span> mapedBuffer <span class="token operator">:</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            getMessageResult<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>mapedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-3-popmessageprocessor-appendcheckpoint" tabindex="-1"><a class="header-anchor" href="#_4-2-3-popmessageprocessor-appendcheckpoint" aria-hidden="true">#</a> 4.2.3 <code>PopMessageProcessor#appendCheckPoint</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在 POP 拉取消息后调用，添加 CheckPoint，等待 ACK
 *
 * <span class="token keyword">@param</span> <span class="token parameter">requestHeader</span>
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span> POP 的 Topic
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span> Revive 队列 ID
 * <span class="token keyword">@param</span> <span class="token parameter">queueId</span> POP 的队列 ID
 * <span class="token keyword">@param</span> <span class="token parameter">offset</span> POP 消息的起始偏移量
 * <span class="token keyword">@param</span> <span class="token parameter">getMessageTmpResult</span> POP 一批消息的结果
 * <span class="token keyword">@param</span> <span class="token parameter">popTime</span> POP 时间
 * <span class="token keyword">@param</span> <span class="token parameter">brokerName</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">appendCheckPoint</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PopMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span>
                              <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>
                              <span class="token keyword">final</span> <span class="token class-name">GetMessageResult</span> getMessageTmpResult<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> popTime<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> brokerName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// add check point msg to revive log</span>
    <span class="token keyword">final</span> <span class="token class-name">PopCheckPoint</span> ck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... 构造 PopCheckPoint，赋值过程省略</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> msgQueueOffset <span class="token operator">:</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加所有拉取的消息的偏移量与起始偏移量的差值</span>
        ck<span class="token punctuation">.</span><span class="token function">addDiff</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgQueueOffset <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将 Offset 放入内存</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> addBufferSuc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCk</span><span class="token punctuation">(</span>
        ck<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>addBufferSuc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 放入内存匹配失败（内存匹配未开启），将 Offset 放入内存和磁盘</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCkJustOffset</span><span class="token punctuation">(</span>
        ck<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-broker-端-ack-消息" tabindex="-1"><a class="header-anchor" href="#_4-3-broker-端-ack-消息" aria-hidden="true">#</a> 4.3 Broker 端 Ack 消息</h3><h4 id="_4-3-1-ackmessageprocessor-processrequest" tabindex="-1"><a class="header-anchor" href="#_4-3-1-ackmessageprocessor-processrequest" aria-hidden="true">#</a> 4.3.1 <code>AckMessageProcessor#processRequest</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 处理 Ack 消息请求，每次 Ack 一条消息
 *
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">brokerAllowSuspend</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">RemotingCommandException</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span>
                                       <span class="token keyword">boolean</span> brokerAllowSuspend<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析请求头</span>
    <span class="token keyword">final</span> <span class="token class-name">AckMessageRequestHeader</span> requestHeader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AckMessageRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">AckMessageRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AckMsg</span> ackMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AckMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setOpaque</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOpaque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... 校验</span>
    
    <span class="token comment">// 拆分消息句柄字符串</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> extraInfo <span class="token operator">=</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getExtraInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用请求头中的信息构造 AckMsg</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setAckOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setStartOffset</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getCkQueueOffset</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setPopTime</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rqId <span class="token operator">=</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getReviveQid</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBrokerAckNums</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupAckNums</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rqId <span class="token operator">==</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token constant">POP_ORDER_REVIVE_QUEUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 顺序消息 ACK</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 普通消息 ACK</span>
    <span class="token comment">// 先尝试放入内存匹配，成功则直接返回。失败可能是内存匹配未开启</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopBufferMergeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAk</span><span class="token punctuation">(</span>rqId<span class="token punctuation">,</span> ackMsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构造 Ack 消息</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>reviveTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//msgInner.setQueueId(Integer.valueOf(extraInfo[3]));</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>rqId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">ACK_TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornTimestamp</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setStoreHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 定时消息，定时到唤醒重试时间投递</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setDeliverTimeMs</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">,</span> <span class="token class-name">PopMessageProcessor</span><span class="token punctuation">.</span><span class="token function">genAckUniqueId</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存 Ack 消息到磁盘</span>
    <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getEscapeBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessageToSpecificQueue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FLUSH_DISK_TIMEOUT</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FLUSH_SLAVE_TIMEOUT</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;put ack msg error:&quot;</span> <span class="token operator">+</span> putMessageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-broker-端-checkpoint-与-ackmsg-匹配" tabindex="-1"><a class="header-anchor" href="#_4-4-broker-端-checkpoint-与-ackmsg-匹配" aria-hidden="true">#</a> 4.4 Broker 端 <code>CheckPoint</code> 与 <code>AckMsg</code> 匹配</h3><h4 id="_4-4-1-popbuffermergeservice-addck" tabindex="-1"><a class="header-anchor" href="#_4-4-1-popbuffermergeservice-addck" aria-hidden="true">#</a> 4.4.1 <code>PopBufferMergeService#addCk</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * POP 消息后，新增 CheckPoint，放入内存 Buffer
 *
 * <span class="token keyword">@param</span> <span class="token parameter">point</span>
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQueueId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQueueOffset</span>
 * <span class="token keyword">@param</span> <span class="token parameter">nextBeginOffset</span>
 * <span class="token keyword">@return</span> 是否添加成功
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addCk</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> point<span class="token punctuation">,</span> <span class="token keyword">int</span> reviveQueueId<span class="token punctuation">,</span> <span class="token keyword">long</span> reviveQueueOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> nextBeginOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// key: point.getT() + point.getC() + point.getQ() + point.getSo() + point.getPt()</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopBufferMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 内存匹配服务是否开启</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serving<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 距离下次可重试 Pop 消费的时刻 &lt; 4.5s</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, timeout, {}, {}&quot;</span><span class="token punctuation">,</span> point<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkMaxBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, max size, {}, {}&quot;</span><span class="token punctuation">,</span> point<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">(</span>reviveQueueId<span class="token punctuation">,</span> reviveQueueOffset<span class="token punctuation">,</span> point<span class="token punctuation">,</span> nextBeginOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkQueueOk</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将 CheckPoint 放入 Offset 队列</span>
    <span class="token function">putOffsetQueue</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 CheckPoint 放入内存 Buffer</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getMergeKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-popbuffermergeservice-addak" tabindex="-1"><a class="header-anchor" href="#_4-4-2-popbuffermergeservice-addak" aria-hidden="true">#</a> 4.4.2 <code>PopBufferMergeService#addAk</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消息 ACK，与内存中的 CheckPoint 匹配
 *
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ackMsg</span>
 * <span class="token keyword">@return</span> 是否匹配成功
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addAk</span><span class="token punctuation">(</span><span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span> <span class="token class-name">AckMsg</span> ackMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果未开启内存匹配，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopBufferMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serving<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据 ACK 的消息找到内存 Buffer 中的 CheckPoint</span>
        <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 找不到 CheckPoint</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, no ck, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> ackMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 内存中仅保存 Offset，实际已经保存到磁盘，内存中不处理 ACK 消息的匹配，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> pointWrapper<span class="token punctuation">.</span><span class="token function">getCk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, almost timeout for revive, {}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> pointWrapper<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, stay too long, {}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> pointWrapper<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 标记该 CheckPoint 已经被 ACK</span>
        <span class="token keyword">int</span> indexOfAck <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">indexOfAck</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getAckOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexOfAck <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置 CheckPoint 中被 Ack 消息的 bit 码表为 1</span>
            <span class="token function">markBitCAS</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexOfAck<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]Invalid index of ack, reviveQid={}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack error, rqId=&quot;</span> <span class="token operator">+</span> reviveQid <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-popbuffermergeservice-scan" tabindex="-1"><a class="header-anchor" href="#_4-4-3-popbuffermergeservice-scan" aria-hidden="true">#</a> 4.4.3 <code>PopBufferMergeService#scan</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 扫描内存中的 CheckPoint
 * 把已经匹配或存盘的 CheckPoint 移出 buffer
 * 把已经全部 Ack 的 CheckPoint 存盘
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> countCk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历所有内存中的 CheckPoint</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果 CheckPoint 已经在磁盘中，或者全部消息都匹配成功，从内存中 buffer 中移除</span>
        <span class="token comment">// just process offset(already stored at pull thread), or buffer ck(not stored and ack finish)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isCkDone</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">isCkDoneForFinish</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            counter<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> pointWrapper<span class="token punctuation">.</span><span class="token function">getCk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 是否要从内存中移除 CheckPoint</span>
        <span class="token keyword">boolean</span> removeCk <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>serving<span class="token punctuation">;</span>
        <span class="token comment">// 距离 ReviveTime 时间小于阈值（默认3s）</span>
        <span class="token comment">// ck will be timeout</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            removeCk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 在内存中时间大于阈值（默认10s）</span>
        <span class="token comment">// the time stayed is too long</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            removeCk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]ck finish fail, stay too long, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// double check</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCkDone</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// just offset should be in store.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getReviveQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">putCkToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countCk<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>removeCk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将 CheckPoint 包装成消息放入磁盘，从内存中移除</span>
            <span class="token comment">// put buffer ak to store</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getReviveQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">putCkToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countCk<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 在内存中移除 CheckPoint 前，把它当中已经 Ack 的消息也作为 Ack 消息存入磁盘</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> point<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 遍历 CheckPoint 中消息 bit 码表每一位，检查是否已经 Ack 并且没有存入磁盘</span>
                <span class="token comment">// reput buffer ak to store</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getToStoreBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">putAckToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token function">markBitCAS</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getToStoreBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCkDoneForFinish</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]ck finish, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                counter<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 扫描已经完成的 CheckPoint，为它们提交消息消费进度</span>
    <span class="token keyword">int</span> offsetBufferSize <span class="token operator">=</span> <span class="token function">scanCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    scanTimes<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>scanTimes <span class="token operator">&gt;=</span> countOfMinute1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scanTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="_4-4-4-popreviveservice-consumerevivemessage" tabindex="-1"><a class="header-anchor" href="#_4-4-4-popreviveservice-consumerevivemessage" aria-hidden="true">#</a> 4.4.4 <code>PopReviveService#consumeReviveMessage</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费 Revive Topic 中的消息，匹配 ACK 消息和 CheckPoint
 * CK 消息放到 Map 中，ACK 消息根据 Map key 匹配 CK 消息，更新 CK 消息的码表以完成 ACK
 * 只对 CK 进行标记
 * 消费时间差 2s 内的 CK、ACK 消息，或 4s 没有消费到新消息
 *
 * <span class="token keyword">@param</span> <span class="token parameter">consumeReviveObj</span> CK 与 ACK 匹配对象，用于 Revive 需要重试 Pop 消费的消息
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">consumeReviveMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumeReviveObj</span> consumeReviveObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CheckPoint 匹配 map，key = point.getTopic() + point.getCId() + point.getQueueId() + point.getStartOffset() + point.getPopTime()</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span>map<span class="token punctuation">;</span>
    <span class="token keyword">long</span> startScanTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询 ReviveTopic queue 之前的消费进度</span>
    <span class="token keyword">long</span> oldOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryOffset</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">REVIVE_GROUP</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumeReviveObj<span class="token punctuation">.</span>oldOffset <span class="token operator">=</span> oldOffset<span class="token punctuation">;</span>
    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, old offset is {} &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> oldOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> offset <span class="token operator">=</span> oldOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 没有查询到消息的次数</span>
    <span class="token keyword">int</span> noMsgCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> firstRt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// offset self amend</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip scan , revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 查询一批 Revive Topic 中的消息（32条）</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> messageExts <span class="token operator">=</span> <span class="token function">getReviveMessage</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExts <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> messageExts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> old <span class="token operator">=</span> endTime<span class="token punctuation">;</span>
            <span class="token keyword">long</span> timerDelay <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimerMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReadBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> commitLogDelay <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimerMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnqueueBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// move endTime</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> endTime <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span> <span class="token operator">&amp;&amp;</span> timerDelay <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> commitLogDelay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, offset is {}, can not get new msg, old endTime {}, new endTime {}&quot;</span><span class="token punctuation">,</span>
                            queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> old<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 最后一个 CK 的唤醒时间与第一个 CK 的唤醒时间差大于 2s，中断消费</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> firstRt <span class="token operator">&gt;</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span>ackTimeInterval <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            noMsgCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// Fixme: why sleep is useful here?</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 连续 4s 没有消费到新的消息，中断消费</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>noMsgCount <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            noMsgCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startScanTime <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReviveScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, scan timeout  &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 遍历查询到的消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> messageExt <span class="token operator">:</span> messageExts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">CK_TAG</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果是 CheckPoint</span>
                <span class="token class-name">String</span> raw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},find ck, offset:{}, raw : {}&quot;</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> point<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 放入 HashMap，等待 ACK 消息匹配</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置 reviveOffset 为 revive 队列中消息的逻辑 offset</span>
                point<span class="token punctuation">.</span><span class="token function">setReviveOffset</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    firstRt <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">ACK_TAG</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果是 ACK 消息</span>
                <span class="token class-name">String</span> raw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},find ack, offset:{}, raw : {}&quot;</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">AckMsg</span> ackMsg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token class-name">AckMsg</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果 HashMap 中有 CheckPoint，计算 ACK 的 bit 码表</span>
                <span class="token keyword">int</span> indexOfAck <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">indexOfAck</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getAckOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>indexOfAck <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Ack 消息 bit 码表为 1 的位 Ack 成功</span>
                    point<span class="token punctuation">.</span><span class="token function">setBitMap</span><span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexOfAck<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid ack index, {}, {}&quot;</span><span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> deliverTime <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getDeliverTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deliverTime <span class="token operator">&gt;</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> deliverTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        offset <span class="token operator">=</span> offset <span class="token operator">+</span> messageExts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumeReviveObj<span class="token punctuation">.</span>endTime <span class="token operator">=</span> endTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-5-popreviveservice-mergeandrevive" tabindex="-1"><a class="header-anchor" href="#_4-4-5-popreviveservice-mergeandrevive" aria-hidden="true">#</a> 4.4.5 <code>PopReviveService#mergeAndRevive</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 匹配消费到的一批 CK 和 ACK 消息，对于没有成功 ACK 的消息，重发到重试 Topic
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">mergeAndRevive</span><span class="token punctuation">(</span><span class="token class-name">ConsumeReviveObj</span> consumeReviveObj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取排序后的 CheckPoint 列表</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PopCheckPoint</span><span class="token punctuation">&gt;</span></span> sortList <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span><span class="token function">genSortList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
    <span class="token keyword">long</span> newOffset <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span>oldOffset<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint <span class="token operator">:</span> sortList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 如果没有到 Revive 时间，跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeReviveObj<span class="token punctuation">.</span>endTime <span class="token operator">-</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span>ackTimeInterval <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 从 CK 中解析原 Topic 并检查该 Topic 是否存在，如果不存在则跳过</span>
        <span class="token comment">// check normal topic, skip ck , if normal topic is not exist</span>
        <span class="token class-name">String</span> normalTopic <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">parseNormalTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span>normalTopic<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get normal topic {} , then continue &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerController<span class="token punctuation">.</span><span class="token function">getSubscriptionGroupManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSubscriptionGroupConfig</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get cid {} , then continue &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 重发 CK 中没有 Ack 的所有消息</span>
        <span class="token function">reviveMsgFromCk</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 匹配和重试完成后，更新 ReviveTopic 消费进度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newOffset <span class="token operator">&gt;</span> consumeReviveObj<span class="token punctuation">.</span>oldOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip commit, revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_HOST</span><span class="token punctuation">,</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">REVIVE_GROUP</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumeReviveObj<span class="token punctuation">.</span>newOffset <span class="token operator">=</span> newOffset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-6-popreviveservice-重试消息" tabindex="-1"><a class="header-anchor" href="#_4-4-6-popreviveservice-重试消息" aria-hidden="true">#</a> 4.4.6 <code>PopReviveService</code>: 重试消息</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 重发 CK 中没有 Ack 的所有消息
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reviveMsgFromCk</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历 CK 中的所有消息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// retry msg</span>
        <span class="token keyword">long</span> msgOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">ackOffsetByIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询 CK 消息对应的真正消息</span>
        <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> <span class="token function">getBizMessage</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgOffset<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get biz msg topic is {}, offset is {} , then continue &quot;</span><span class="token punctuation">,</span>
                            queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//skip ck from last epoch</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> messageExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},skip ck from last epoch {}&quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 唤醒没有被 ACK 的消息，发到重试队列</span>
        <span class="token function">reviveRetry</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">,</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 根据 CheckPoint 唤醒没有被 ACK 的消息，发到重试队列
 *
 * <span class="token keyword">@param</span> <span class="token parameter">popCheckPoint</span> CK
 * <span class="token keyword">@param</span> <span class="token parameter">messageExt</span> 要被重试的消息
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reviveRetry</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint<span class="token punctuation">,</span> <span class="token class-name">MessageExt</span> messageExt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip retry , revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 构造新的消息</span>
    <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 唤醒的消息发到重试 Topic</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornTimestamp</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornHost</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setStoreHost</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重试次数 += 1</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setReconsumeTimes</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_FIRST_POP_TIME</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_FIRST_POP_TIME</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加 Pop 重试 Topic</span>
    <span class="token function">addRetryTopicIfNoExit</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存重试消息到存储</span>
    <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getEscapeBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessageToSpecificQueue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},retry msg , ck={}, msg queueId {}, offset {}, reviveDelay={}, result is {} &quot;</span><span class="token punctuation">,</span>
                        queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> putMessageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AppendMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId=&quot;</span> <span class="token operator">+</span> queueId <span class="token operator">+</span> <span class="token string">&quot;,revive error ,msg is :&quot;</span> <span class="token operator">+</span> msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ... 更新统计数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>
            <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">parseNormalTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li><a href="https://github.com/apache/rocketmq/wiki/%5BRIP-19%5D-Server-side-rebalance,--lightweight-consumer-client-support" target="_blank" rel="noopener noreferrer">[RIP 19] Server side rebalance, lightweight consumer client support<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://developer.aliyun.com/article/801815" target="_blank" rel="noopener noreferrer">RocketMQ 5.0 POP 消费模式探秘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>欢迎关注公众号【消息中间件】（middleware-mq），更新消息中间件的源码解析和最新动态！</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/src/rocketmq/20221212-rocketmq-consumer-7-pop-consume.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span>,<!--]--><!--[--><span class="contributor" title="email: jjhfen00@163.com">Scarb</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2023 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-eaa093f0.js" defer></script>
  </body>
</html>
