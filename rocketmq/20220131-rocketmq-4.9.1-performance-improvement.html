<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html"><meta property="og:site_name" content="é‡‘ç”²è™«çš„åšå®¢"><meta property="og:title" content="RocketMQ 4.9.1 æ€§èƒ½ä¼˜åŒ– æºç å‰–æ"><meta property="og:description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html (http://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2022-12-15T17:51:36.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2022-01-31T00:00:00.000Z"><meta property="article:modified_time" content="2022-12-15T17:51:36.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ 4.9.1 æ€§èƒ½ä¼˜åŒ– æºç å‰–æ","image":[""],"datePublished":"2022-01-31T00:00:00.000Z","dateModified":"2022-12-15T17:51:36.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>RocketMQ 4.9.1 æ€§èƒ½ä¼˜åŒ– æºç å‰–æ | é‡‘ç”²è™«çš„åšå®¢</title><meta name="description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html (http://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-c0752bdb.css" as="style"><link rel="stylesheet" href="/assets/style-c0752bdb.css">
    <link rel="modulepreload" href="/assets/app-eaa093f0.js"><link rel="modulepreload" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-93e36349.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-33b1adea.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/index.html-19d3809b.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/index.html-2ffe9047.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-a7ecb646.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-timer.html-3783de8e.js" as="script"><link rel="prefetch" href="/assets/index.html-ccce5c4e.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-ca8df479.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-383d1ff0.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-1b153845.js" as="script"><link rel="prefetch" href="/assets/index.html-fed19b8d.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-40e66472.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-db82fded.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-7a035718.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-4d2cb3a2.js" as="script"><link rel="prefetch" href="/assets/index.html-3f101793.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-dde4ad3c.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-e9d75c4b.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-5e2be81b.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-74b12dbf.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-f5e34f6f.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-c9138520.js" as="script"><link rel="prefetch" href="/assets/index.html-4808fc58.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-c6a8fa10.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-6cc048ce.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-9e98139f.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-7c41100f.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-88bde295.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-52089ac5.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-9acf57e1.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-51015efc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-abc2abce.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-33271087.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-e0c3f1a1.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-53a87b09.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7be6394f.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-26b85bb0.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-3f5bfad8.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-f0964ee0.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-76d2fb74.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-9f2d304c.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-f7aa5d2e.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-687deffa.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-3d6db503.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-8af4b82f.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-fbcd892c.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-f30f7734.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-fed2f058.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-165a8844.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-263232fe.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-1378ef83.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-f1f5acad.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-timer.html-6a8c6820.js" as="script"><link rel="prefetch" href="/assets/index.html-e5c09f60.js" as="script"><link rel="prefetch" href="/assets/404.html-624a8347.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-3b9185cc.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-1048d6b7.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-e3494be4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="é‡‘ç”²è™«çš„åšå®¢"><!----><span class="vp-site-name hide-in-pad">é‡‘ç”²è™«çš„åšå®¢</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="æ˜é‡‘" class="nav-link"><!---->æ˜é‡‘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ 4.9.1 æ€§èƒ½ä¼˜åŒ– æºç å‰–æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-01-31T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 16 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT16M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#æ¦‚è¿°">æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ä¼˜åŒ–åˆ†æ">ä¼˜åŒ–åˆ†æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–-1">äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–ï¼ˆ1ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–-ç§»é™¤-2-4">ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–/ç§»é™¤ï¼ˆ2-4ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´-5">æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´ï¼ˆ5ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç§»é™¤-commitlog-ä¸­åŒ…å«é‡å¤ä»£ç çš„-putmessage-putmessages-æ–¹æ³•-6">ç§»é™¤ CommitLog ä¸­åŒ…å«é‡å¤ä»£ç çš„ putMessage/putMessages æ–¹æ³•ï¼ˆ6ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼-7">è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼ï¼ˆ7ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¼˜åŒ–-putmessage-é”å†…æ“ä½œ-8-12">ä¼˜åŒ– putMessage é”å†…æ“ä½œï¼ˆ8-12ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¼˜åŒ–æ¶ˆæ¯-header-è§£æçš„æ€§èƒ½-13-15">ä¼˜åŒ–æ¶ˆæ¯ Header è§£æçš„æ€§èƒ½ï¼ˆ13-15ï¼‰</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>åŸæ–‡åœ°å€ï¼š<a href="http://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-4-9-1-æ€§èƒ½ä¼˜åŒ–-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#rocketmq-4-9-1-æ€§èƒ½ä¼˜åŒ–-æºç å‰–æ" aria-hidden="true">#</a> RocketMQ 4.9.1 æ€§èƒ½ä¼˜åŒ– æºç å‰–æ</h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#æ¦‚è¿°" class="router-link-active router-link-exact-active">æ¦‚è¿°</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#ä¼˜åŒ–åˆ†æ" class="router-link-active router-link-exact-active">ä¼˜åŒ–åˆ†æ</a><ul><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–-1" class="router-link-active router-link-exact-active">äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–ï¼ˆ1ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–-ç§»é™¤-2-4" class="router-link-active router-link-exact-active">ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–/ç§»é™¤ï¼ˆ2-4ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´-5" class="router-link-active router-link-exact-active">æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´ï¼ˆ5ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#ç§»é™¤-commitlog-ä¸­åŒ…å«é‡å¤ä»£ç çš„-putmessage-putmessages-æ–¹æ³•-6" class="router-link-active router-link-exact-active">ç§»é™¤ CommitLog ä¸­åŒ…å«é‡å¤ä»£ç çš„ putMessage/putMessages æ–¹æ³•ï¼ˆ6ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼-7" class="router-link-active router-link-exact-active">è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼ï¼ˆ7ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#ä¼˜åŒ–-putmessage-é”å†…æ“ä½œ-8-12" class="router-link-active router-link-exact-active">ä¼˜åŒ– putMessage é”å†…æ“ä½œï¼ˆ8-12ï¼‰</a></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#ä¼˜åŒ–æ¶ˆæ¯-header-è§£æçš„æ€§èƒ½-13-15" class="router-link-active router-link-exact-active">ä¼˜åŒ–æ¶ˆæ¯ Header è§£æçš„æ€§èƒ½ï¼ˆ13-15ï¼‰</a></li></ul></li><li><a aria-current="page" href="/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.html#å‚è€ƒèµ„æ–™" class="router-link-active router-link-exact-active">å‚è€ƒèµ„æ–™</a></li></ul></nav><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h2><p>RocketMQ 4.9.1 ç‰ˆæœ¬é’ˆå¯¹ Broker åšäº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–ï¼Œè¿™ä¸€æ‰¹ PR éƒ½æŒ‚è½½ <a href="https://github.com/apache/rocketmq/issues/2883" target="_blank" rel="noopener noreferrer">ISSUE#2883<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ä¸‹ã€‚</p><blockquote><p>å’Œ4.9.0ç‰ˆæœ¬ç›¸æ¯”ï¼Œå°æ¶ˆæ¯å®æ—¶ç”Ÿäº§çš„ TPS æå‡äº†çº¦ 28%ã€‚</p></blockquote><blockquote><p>I have some commit to Improve produce performance in M/S mode:</p><ol><li>Change log level to debug: &quot;Half offset {} has been committed/rolled back&quot;</li><li>Optimise lock in WaitNotifyObject</li><li>Remove lock in HAService</li><li>Remove lock in GroupCommitService</li><li>Eliminate array copy in HA</li><li>Remove putMessage/putMessages method in CommitLog which has too many duplicated code.</li><li>Change default value of some parameters: sendMessageThreadPoolNums/useReentrantLockWhenPutMessage/flushCommitLogTimed/endTransactionThreadPoolNums</li><li>Optimise performance of asyncPutMessage (extract some code out of putMessage lock)</li><li>extract generation of msgId out of lock in CommitLog (now only for single message processor)</li><li>extract generation of topicQueueTable key out of sync code</li><li>extract generation of msgId out of lock in CommitLog (for batch)</li><li>fix ipv6 problem introduced in commit &quot;Optimise performance of asyncPutMessage (extract some code out of putMessage lock)&quot;</li><li>Remove an duplicate MessageDecoder.string2messageProperties for each message, and prevent store &quot;WAIT=true&quot; property (in most case) to save 9 bytes for each message.</li><li>Improve performance of string2messageProperties/messageProperties2String, and save 1 byte for each message.</li><li>Optimise parse performance for SendMessageRequestHeaderV2</li></ol></blockquote><p>ä¸‹é¢ä¼šä»æºç å±‚é¢æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ä¼˜åŒ–ç‚¹å’Œä¼˜åŒ–çš„åŸå› ã€‚äº†è§£è¿™äº›ä¼˜åŒ–éœ€è¦å¯¹ RocketMQ æºç æ¯”è¾ƒç†Ÿæ‚‰ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä¼šåœ¨è®²è§£ä¼˜åŒ–ç‚¹å‰è¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†ã€‚</p><h2 id="ä¼˜åŒ–åˆ†æ" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–åˆ†æ" aria-hidden="true">#</a> ä¼˜åŒ–åˆ†æ</h2><h3 id="äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–-1" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–-1" aria-hidden="true">#</a> äº‹åŠ¡æ¶ˆæ¯æ—¥å¿—ä¼˜åŒ–ï¼ˆ1ï¼‰</h3><blockquote><ol><li>Change log level to debug: &quot;Half offset {} has been committed/rolled back&quot;</li></ol></blockquote><p>é»˜è®¤çš„é…ç½®ä¸‹æ¯æ¡æ¶ˆæ¯éƒ½ä¼šæ‰“å‡ºä¸€æ¡æ—¥å¿—ï¼Œæ”¹åŠ¨ä¸»è¦ç§»é™¤äº†äº‹åŠ¡æ¶ˆæ¯ä¸­çš„æ—¥å¿—æ‰“å°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Queue={} process time reach max={}&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>removeMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span>~<span class="token operator">~</span>info<span class="token operator">~</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token string">&quot;Half offset {} has been committed/rolled back&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> removedOpOffset <span class="token operator">=</span> removeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        doneOpOffset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¼˜åŒ–æ¯”è¾ƒç®€å•ï¼Œä»è¿™å½“ä¸­å¯ä»¥å­¦åˆ°çš„æ˜¯åœ¨æ‰“å°æ—¥å¿—æ—¶éœ€è¦è°¨æ…ï¼Œå°¤å…¶æ˜¯å¯¹äº RocketMQ è¿™ç§é«˜æ€§èƒ½ä¸­é—´ä»¶æ¥è¯´ï¼Œæ—¥å¿—çš„æ‰“å°å¯èƒ½ä¼šå ç”¨è¾ƒå¤š CPU èµ„æºã€‚</p><p>æ­¤å¤–ï¼Œå¦‚æœæ—¥å¿—ä¸­æ¶‰åŠå­—ç¬¦ä¸²æ‹¼æ¥ç­‰æ“ä½œï¼Œæ¶ˆè€—ä¼šæ›´å¤§ï¼Œåº”å½“é¿å…ã€‚</p><h3 id="ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–-ç§»é™¤-2-4" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–-ç§»é™¤-2-4" aria-hidden="true">#</a> ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·æµç¨‹ä¸­é”çš„ä¼˜åŒ–/ç§»é™¤ï¼ˆ2-4ï¼‰</h3><blockquote><p>Improve produce performance in M/S mode</p><ol><li>Optimise lock in WaitNotifyObject</li><li>Remove lock in HAService</li><li>Remove lock in GroupCommitService</li></ol></blockquote><p>åœ¨åˆ†æå¦‚ä½•ä¼˜åŒ–ä¹‹å‰éœ€è¦å­¦ä¹ ä¸€äº›å‰ç½®æŒ‡ç¤ºï¼Œçœ‹ä¸€ä¸‹ RocketMQ ä¸­ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜çš„åŸç†ã€‚è¿™ä¸¤ä¸ªæ“ä½œåŸç†åŸºæœ¬ç›¸åŒã€‚</p><h4 id="å‰ç½®çŸ¥è¯†-ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å‰ç½®çŸ¥è¯†-ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å¼" aria-hidden="true">#</a> å‰ç½®çŸ¥è¯†ï¼šä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å¼</h4><p>åœ¨ RocketMQ å†…éƒ¨ï¼Œä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜éƒ½æ˜¯å¤šçº¿ç¨‹åä½œå¤„ç†çš„ã€‚ä»¥ä¸»ä»å¤åˆ¶ä¸ºä¾‹ï¼ˆ<code>GroupTransferService</code>ï¼‰ï¼Œæ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼ˆå¤šä¸ªï¼‰ä¸æ–­æ¥æ”¶æ¶ˆæ¯ï¼Œäº§ç”Ÿå¾…å¤åˆ¶çš„æ¶ˆæ¯ï¼Œå¦å¤–æœ‰ä¸€ä¸ª <code>ServiceThread</code> å•çº¿ç¨‹å¤„ç†å¤åˆ¶ç»“æœï¼Œå¯ä»¥æŠŠå‰è€…çœ‹åšæ•°æ®ç”Ÿäº§è€…ï¼Œåè€…çœ‹åšæ•°æ®æ¶ˆè´¹è€…ï¼ŒRocketMQ ä½¿ç”¨äº†åŒ Buffer æ¥è¾¾åˆ°æ‰¹é‡å¤„ç†çš„ç›®çš„ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œæ¶ˆè´¹è€…æ­£åœ¨å¤„ç†æ•°æ®çš„åŒæ—¶ï¼Œç”Ÿäº§è€…å¯ä»¥ä¸å—å½±å“çš„ç»§ç»­æ·»åŠ æ•°æ®ï¼Œç¬¬ä¸€é˜¶æ®µç”Ÿäº§è€… Buffer æœ‰ 3 æ¡æ•°æ®ï¼Œæ¶ˆè´¹è€… Buffer æœ‰ 2 æ¡æ•°æ®ï¼Œç”±äºæ¶ˆè´¹è€…æ˜¯å•çº¿ç¨‹ï¼Œæ²¡æœ‰åˆ«çš„çº¿ç¨‹è·Ÿå®ƒç«äº‰ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ‰¹é‡å¤„ç†è¿™ 2 æ¡æ•°æ®ï¼Œå®Œæˆåå®ƒä¼šäº¤æ¢è¿™ä¸¤ä¸ª Buffer çš„å¼•ç”¨ï¼Œäºæ˜¯æ¥ä¸‹æ¥çš„ç¬¬äºŒé˜¶æ®µå®ƒåˆå¯ä»¥æ‰¹é‡å¤„ç† 3 æ¡æ•°æ®ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215540.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h4 id="ä¼˜åŒ–1-ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­é‡é‡çº§é”synchronizedæ”¹ä¸ºè‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–1-ä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­é‡é‡çº§é”synchronizedæ”¹ä¸ºè‡ªæ—‹é”" aria-hidden="true">#</a> ä¼˜åŒ–1ï¼šä¸»ä»å¤åˆ¶å’ŒåŒæ­¥åˆ·ç›˜ä¸­é‡é‡çº§é”synchronizedæ”¹ä¸ºè‡ªæ—‹é”</h4><p>ä¹‹å‰ RocketMQ åœ¨ç”Ÿäº§è€…å†™å…¥ <code>putRequest()</code> ã€äº¤æ¢ Buffer å¼•ç”¨ <code>swapRequests()</code> ã€ä»¥åŠå†…éƒ¨å¤„ç†ä¸­éƒ½ä½¿ç”¨äº†é‡é‡çº§é”<code>synchronized</code>ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><p>å®é™… <code>putRequest()</code> æ–¹æ³•ä¸­åªåšäº†æ·»åŠ æ•°æ®åˆ°åˆ—è¡¨çš„æ“ä½œï¼›<code>swapRequests()</code> ä¸­åšäº†äº¤æ¢æ“ä½œï¼Œè€—æ—¶éƒ½è¾ƒå°ï¼Œæ•…å¯ä»¥æ¢æˆè‡ªæ—‹é”ã€‚æ¯æ¬¡åŠ è§£é”éƒ½<strong>åªæœ‰ 2 æ¬¡ CAS æ“ä½œçš„å¼€é”€ï¼Œè€Œä¸å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢</strong>ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215541.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h4 id="ä¼˜åŒ–2-waitnotifyobject-ç±»" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–2-waitnotifyobject-ç±»" aria-hidden="true">#</a> ä¼˜åŒ–2ï¼šWaitNotifyObject ç±»</h4><p><code>WaitNotifyObject</code> è¢«ç”¨äºåšçº¿ç¨‹ä¹‹é—´çš„å¼‚æ­¥é€šçŸ¥ã€‚åœ¨ä¸»ä»å¤åˆ¶é€»è¾‘ä¸­è¢«ç”¨åˆ°ã€‚ç”¨æ³•ç±»ä¼¼ <code>synchronized</code> çš„ <code>wait()</code> å’Œ <code>nofityAll()</code>ï¼Œç­‰å¾…-é€šçŸ¥æœºåˆ¶ã€‚</p><p>ä¸»ä»å¤åˆ¶çº¿ç¨‹å¾ªç¯ä¼ è¾“æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è°ƒç”¨ <code>WaitNotifyObject#allWaitForRunning()</code> æ–¹æ³•ç­‰å¾…ã€‚</p><p>åœ¨CommitLogä¿å­˜æ¶ˆæ¯ä¹‹åï¼Œè°ƒç”¨ <code>WaitNotifyObject#wakeUpAll()</code> æ–¹æ³•å”¤é†’ä¸»ä»å¤åˆ¶çº¿ç¨‹ã€‚</p><p>æœ¬æ¬¡ä¼˜åŒ–å‡å°‘äº†éœ€è¦è¿›å…¥åŒæ­¥ä»£ç å—çš„æ¬¡æ•°ã€‚</p><hr><p>ä¿®æ”¹ç‚¹ï¼š<code>waitingThreadTable</code> æ”¹ä¸º <code>ConcurrentHashMap</code>ï¼Œç„¶åå¯ä»¥å°† <code>waitingThreadTable</code> ç§»å‡ºåŒæ­¥ä»£ç å—ã€‚</p><p><code>volatile boolean hasNotified</code> æ”¹ä¸º <code>AtomicBoolean hasNotified</code></p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215542.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h3 id="æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´-5" tabindex="-1"><a class="header-anchor" href="#æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´-5" aria-hidden="true">#</a> æ¶ˆé™¤ä¸»ä»å¤åˆ¶ä¸­ä¸å¿…è¦çš„æ•°ç»„æ‹·è´ï¼ˆ5ï¼‰</h3><blockquote><ol start="5"><li>Eliminate array copy in HA</li></ol></blockquote><p>äº†è§£è¿™ä¸ªä¼˜åŒ–ä¹‹å‰éœ€è¦å…ˆå­¦ä¹ ä¸€ä¸‹å‰ç½®çŸ¥è¯†ï¼ŒåŒ…æ‹¬ RocketMQ ä¸­ CommitLog ä½¿ç”¨çš„å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå’Œä¸»ä»å¤åˆ¶çš„æµç¨‹ã€‚</p><h4 id="å†…å­˜æ˜ å°„æ–‡ä»¶mmap" tabindex="-1"><a class="header-anchor" href="#å†…å­˜æ˜ å°„æ–‡ä»¶mmap" aria-hidden="true">#</a> å†…å­˜æ˜ å°„æ–‡ä»¶mmap</h4><p>RocketMQ çš„ CommitLog æ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆmmapï¼‰ã€‚ä¸‹é¢è¿™å¼ å›¾å¯¹æ¯”äº†æ™®é€š IO å’Œå†…å­˜æ˜ å°„ IO ä¹‹é—´çš„åŒºåˆ«ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215543.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>mmap å°†æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·å†…å­˜ï¼Œä½¿å¾—å¯¹æ–‡ä»¶çš„æ“ä½œä¸ç”¨å†éœ€è¦æ‹·è´åˆ°PageCacheï¼Œè€Œæ˜¯è½¬åŒ–ä¸ºå¯¹æ˜ å°„åœ°å€æ˜ å°„çš„PageCacheçš„æ“ä½œï¼Œä½¿éšæœºè¯»å†™æ–‡ä»¶å’Œè¯»å†™å†…å­˜æ‹¥æœ‰ç›¸ä¼¼çš„é€Ÿåº¦ï¼ˆéšæœºåœ°å€è¢«æ˜ å°„åˆ°äº†å†…å­˜ï¼‰</p><h4 id="ä¸»ä»å¤åˆ¶æµç¨‹æ¦‚è¦" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶æµç¨‹æ¦‚è¦" aria-hidden="true">#</a> ä¸»ä»å¤åˆ¶æµç¨‹æ¦‚è¦</h4><p>RocketMQ ä¸»ä»å¤åˆ¶æœºåˆ¶ä¼šåœ¨æ¶ˆæ¯å†™å…¥ CommitLog ä¹‹åï¼ŒMaster Broker å°†æ¶ˆæ¯å‘é€åˆ° Slaveï¼Œè¾¾åˆ°æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚</p><p>æœ¬æ¬¡ä¿®æ”¹ç‚¹æ˜¯åœ¨ä¸»ä»å¤åˆ¶çš„ Slave å¤„ç†è¿‡ç¨‹å½“ä¸­ã€‚HAClient æ˜¯ Slave è¿æ¥ Master çš„å®ç°ç±»ã€‚</p><p><code>HAClient#run()</code> æ–¹æ³•åšäº†ä»¥ä¸‹è¿™äº›äº‹ï¼š</p><ol><li>salveè¿æ¥åˆ°masterï¼Œå‘masterä¸ŠæŠ¥slaveå½“å‰çš„offset</li><li>masteræ”¶åˆ°åç¡®è®¤ç»™slaveå‘é€æ•°æ®çš„å¼€å§‹ä½ç½®</li><li>masteræŸ¥è¯¢å¼€å§‹ä½ç½®å¯¹åº”çš„MappedFIle</li><li>masterå°†æŸ¥æ‰¾åˆ°çš„æ•°æ®å‘é€ç»™slave</li><li>slaveæ”¶åˆ°æ•°æ®åä¿å­˜åˆ°è‡ªå·±çš„CommitLog</li></ol><p>å…¶ä¸­4ã€5æ­¥ï¼ŒSlave æ¥æ”¶åˆ°çš„æ•°æ®å­˜åœ¨ä¸€ä¸ª ByteBuffer é‡Œé¢ï¼ŒæŠŠå®ƒä¿å­˜åˆ° CommitLog çš„æ—¶å€™ï¼ŒåŸæ¥çš„ä»£ç ä¼šæ–°å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç„¶åæŠŠè¯»åˆ°çš„ ByteBuffer é‡Œçš„æ•°æ®æ‹·è´è¿›å»ã€‚</p><h4 id="ä¼˜åŒ–-å‡å°‘å­—èŠ‚æ•°ç»„æ‹·è´" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–-å‡å°‘å­—èŠ‚æ•°ç»„æ‹·è´" aria-hidden="true">#</a> ä¼˜åŒ–ï¼šå‡å°‘å­—èŠ‚æ•°ç»„æ‹·è´</h4><p>åŸå…ˆåœ¨ä¸»ä»å¤åˆ¶é€»è¾‘ä¸­çš„æ•°ç»„æ‹·è´æ­¥éª¤å…¶å®æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå¯ä»¥ç›´æ¥æŠŠä» Master è¯»åˆ°çš„ ByteBuffer ä¼ åˆ°å†™ CommitLog çš„æ–¹æ³•ä¸­ï¼Œå¹¶ä¸”ä¸€å¹¶ä¼ å…¥æ•°æ®çš„å¼€å§‹ä½ç½®å’Œé•¿åº¦ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸é‡æ–°å¤åˆ¶å­—èŠ‚æ•°ç»„çš„æƒ…å†µä¸‹ä¼ é€’ ByteBuffer ä¸­çš„æ•°æ®ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215544.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h3 id="ç§»é™¤-commitlog-ä¸­åŒ…å«é‡å¤ä»£ç çš„-putmessage-putmessages-æ–¹æ³•-6" tabindex="-1"><a class="header-anchor" href="#ç§»é™¤-commitlog-ä¸­åŒ…å«é‡å¤ä»£ç çš„-putmessage-putmessages-æ–¹æ³•-6" aria-hidden="true">#</a> ç§»é™¤ CommitLog ä¸­åŒ…å«é‡å¤ä»£ç çš„ putMessage/putMessages æ–¹æ³•ï¼ˆ6ï¼‰</h3><blockquote><ol start="6"><li>Remove putMessage/putMessages method in CommitLog which has too many duplicated code.</li></ol></blockquote><p>è¯¥ä¼˜åŒ–ä¸»è¦æ˜¯å‡å°‘å†—ä½™ä»£ç </p><p>åŸæœ¬ CommitLog ä¸­æœ‰å¦‚ä¸‹è¿™äº›ä¿å­˜æ¶ˆæ¯çš„æ–¹æ³•</p><ul><li>putMessageï¼šåŒæ­¥ä¿å­˜å•æ¡æ¶ˆæ¯</li><li>asyncPutMessageï¼šå¼‚æ­¥ä¿å­˜å•æ¡æ¶ˆæ¯</li><li>putMessagesï¼šåŒæ­¥ä¿å­˜æ‰¹é‡æ¶ˆæ¯</li><li>asyncPutMessagesï¼šå¼‚æ­¥ä¿å­˜æ‰¹é‡æ¶ˆæ¯</li></ul><p>å…¶å®åŒæ­¥ä¿å­˜å’Œå¼‚æ­¥ä¿å­˜æ¶ˆæ¯çš„é€»è¾‘å·®ä¸å¤šï¼Œä½†æ˜¯åŸæœ¬å¹¶æ²¡æœ‰å¤ç”¨ä»£ç ï¼Œè€Œæ˜¯æ¯ä¸ªæ–¹æ³•éƒ½å•ç‹¬å®ç°ã€‚è¿™å°±å¯¼è‡´åŒæ­¥å’Œå¼‚æ­¥æ–¹æ³•å­˜åœ¨å¤§é‡é‡å¤ä»£ç ã€‚</p><p>è¿™ä¸ª Patch åˆå¹¶äº† putMessage &amp; asyncPutMessage ã€putMessages &amp; asyncPutMessages æ–¹æ³•ï¼Œåœ¨åŒæ­¥æ–¹æ³•ä¸­è°ƒç”¨å¼‚æ­¥æ–¹æ³•çš„ç­‰å¾…æ–¹æ³•ï¼Œåˆ é™¤äº†å¤§é‡é‡å¤ä»£ç ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215545.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215546.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h3 id="è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼-7" tabindex="-1"><a class="header-anchor" href="#è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼-7" aria-hidden="true">#</a> è°ƒæ•´æ¶ˆæ¯å‘é€å‡ ä¸ªå‚æ•°çš„é»˜è®¤å€¼ï¼ˆ7ï¼‰</h3><blockquote><ol start="7"><li>Change default value of some parameters: sendMessageThreadPoolNums/useReentrantLockWhenPutMessage/flushCommitLogTimed/endTransactionThreadPoolNums</li></ol></blockquote><h4 id="æ¶ˆæ¯ä¿å­˜-å‘é€å‚æ•°ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯ä¿å­˜-å‘é€å‚æ•°ä¼˜åŒ–" aria-hidden="true">#</a> æ¶ˆæ¯ä¿å­˜/å‘é€å‚æ•°ä¼˜åŒ–</h4><p>RocketMQåœ¨ä¿å­˜æ¶ˆæ¯æ—¶ï¼Œç”±äºè¦ä¿è¯æ¶ˆæ¯ä¿å­˜åˆ° CommitLog ä¸­æ˜¯é¡ºåºçš„ï¼Œå†™ CommitLog åªèƒ½å•çº¿ç¨‹æ“ä½œï¼Œå†™ä¹‹å‰è¦å…ˆè·å–ä¸€ä¸ªé”ï¼Œè¿™ä¸ªé”ä¹Ÿå°±æ˜¯å½±å“ RocketMQ æ€§èƒ½æœ€å…³é”®çš„ä¸€ä¸ªé”ã€‚</p><p>æœ€æ—©ä¹‹å‰ 3.2.X ç‰ˆæœ¬è¿™ä¸ªé”æ˜¯ synchronizedï¼Œä» RocketMQ4.X å¼€å§‹å¼•å…¥äº†è‡ªæ—‹é”å¹¶ä½œä¸ºé»˜è®¤å€¼ï¼ŒåŒæ—¶å°†å‚æ•° <code>sendMessageThreadPoolNums</code>ï¼ˆå¤„ç†Clientç«¯å‘é€æ¶ˆæ¯çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ï¼‰æ”¹ä¸ºäº† 1ï¼Œè¿™æ ·å¤„ç†æ¯æ¡æ¶ˆæ¯å†™ CommitLog çš„æ—¶å€™æ˜¯ä¸€ä¸ªçº¿ç¨‹åœ¨å†™ï¼Œå¯ä»¥çœä¸‹è¿›å‡ºé‡é‡é”çš„å¼€é”€ã€‚</p><p>ä¸è¿‡è¿™ä¸ªåœ°æ–¹å•çº¿ç¨‹å¤„ç†ï¼Œä»»åŠ¡æœ‰ç‚¹é‡ï¼Œå¤„ç†æ¶ˆæ¯çš„é€»è¾‘å¹¶ä¸æ˜¯å¾€ CommitLog é‡Œé¢ä¸€å†™ï¼ˆæ— æ³•å¹¶è¡Œï¼‰å°±å®Œäº‹çš„ï¼Œè¿˜æœ‰ä¸€äº› CPU å¼€é”€æ¯”è¾ƒå¤§çš„å·¥ä½œï¼Œå¤šçº¿ç¨‹å¤„ç†æ¯”è¾ƒå¥½ï¼Œç»è¿‡ä¸€äº›å®è·µæµ‹è¯•ï¼Œ4 ä¸ªçº¿ç¨‹æ˜¯æ¯”è¾ƒåˆç†çš„æ•°å€¼ï¼Œå› æ­¤è¿™ä¸ªå‚æ•°é»˜è®¤å€¼æ”¹ä¸º <code>MIN(é€»è¾‘å¤„ç†å™¨æ•°, 4)</code>ã€‚</p><p>æ—¢ç„¶æœ‰ 4 ä¸ªçº¿ç¨‹ï¼Œè¿˜ç”¨è‡ªæ—‹é”å¯èƒ½å°±ä¸åˆé€‚äº†ï¼Œå› ä¸ºæ‹¿ä¸åˆ°é”çš„çº¿ç¨‹ä¼šè®© CPU ç™½ç™½ç©ºè½¬ã€‚æ‰€ä»¥æ”¹ç”¨å¯é‡å…¥é”ï¼Œ<code>useReentrantLockWhenPutMessage</code> å‚æ•°è¿˜æ˜¯æ”¹ä¸º true æ¯”è¾ƒå¥½ã€‚</p><h4 id="äº‹åŠ¡æ¶ˆæ¯äºŒé˜¶æ®µå¤„ç†çº¿ç¨‹å¤§å°" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡æ¶ˆæ¯äºŒé˜¶æ®µå¤„ç†çº¿ç¨‹å¤§å°" aria-hidden="true">#</a> äº‹åŠ¡æ¶ˆæ¯äºŒé˜¶æ®µå¤„ç†çº¿ç¨‹å¤§å°</h4><p><code>endTransactionThreadPoolNums</code> æ˜¯äº‹åŠ¡æ¶ˆæ¯äºŒé˜¶æ®µå¤„ç†çº¿ç¨‹å¤§å°ï¼Œ<code>sendMessageThreadPoolNums</code> åˆ™æŒ‡å®šä¸€é˜¶æ®µå¤„ç†çº¿ç¨‹æ± å¤§å°ã€‚å¦‚æœäºŒé˜¶æ®µçš„å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šä¸€é˜¶æ®µï¼Œå°±ä¼šé€ æˆäºŒé˜¶æ®µæ¶ˆæ¯ä¸¢å¤±å¯¼è‡´å¤§é‡å›æŸ¥ï¼Œæ‰€ä»¥å»ºè®® <code>endTransactionThreadPoolNums</code> åº”è¯¥å¤§äº <code>sendMessageThreadPoolNums</code>ï¼Œå»ºè®®è‡³å°‘ 4 å€ã€‚</p><h4 id="å¼€å¯å®šæ—¶åˆ·ç›˜" tabindex="-1"><a class="header-anchor" href="#å¼€å¯å®šæ—¶åˆ·ç›˜" aria-hidden="true">#</a> å¼€å¯å®šæ—¶åˆ·ç›˜</h4><p><code>flushCommitLogTimed</code> å‚æ•°è¡¨ç¤ºæ˜¯å¦å®šæ—¶åˆ·ç›˜ï¼Œä¹‹å‰é»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºå®æ—¶åˆ·ç›˜ã€‚</p><p>æœ¬æ¬¡å¯¹åˆ·ç›˜ç›¸å…³çš„å‚æ•°ä¹Ÿè¿›è¡Œäº†è°ƒæ•´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRocketMQ æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œä½†æ¯æ¬¡å¤„ç†æ¶ˆæ¯éƒ½ä¼šè§¦å‘ä¸€ä¸ªå¼‚æ­¥çš„åˆ·ç›˜è¯·æ±‚ã€‚è¿™æ¬¡å°† <code>flushCommitLogTimed</code> è¿™ä¸ªå‚æ•°æ”¹æˆ trueï¼Œä¹Ÿå°±æ˜¯å®šæ—¶åˆ·ç›˜ï¼ˆé»˜è®¤æ¯ 500msï¼‰ï¼Œå¯ä»¥å¤§å¹…é™ä½å¯¹ IO å‹åŠ›ï¼Œåœ¨ä¸»ä»åŒæ­¥å¤åˆ¶çš„åœºæ™¯ä¸‹ï¼Œå¯é æ€§ä¹Ÿä¸ä¼šé™ä½ã€‚</p><h3 id="ä¼˜åŒ–-putmessage-é”å†…æ“ä½œ-8-12" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–-putmessage-é”å†…æ“ä½œ-8-12" aria-hidden="true">#</a> <strong>ä¼˜åŒ– putMessage é”å†…æ“ä½œ</strong>ï¼ˆ8-12ï¼‰</h3><blockquote><p>Improve produce performance in M/S mode.</p><ol><li>Optimise performance of asyncPutMessage (extract some code out of putMessage lock)</li><li>extract generation of msgId out of lock in CommitLog (now only for single message processor)</li><li>extract generation of topicQueueTable key out of sync code</li><li>extract generation of msgId out of lock in CommitLog (for batch)</li><li>fix ipv6 problem introduced in commit &quot;Optimise performance of asyncPutMessage (extract some code out of putMessage lock)&quot;</li></ol></blockquote><p>CommitLog æ˜¯ RocketMQ æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ã€‚å•ä¸ª Broker ä¸Šæ‰€æœ‰æ¶ˆæ¯éƒ½é¡ºåºä¿å­˜åœ¨ CommitLog ä¸­ã€‚</p><p>å†™ CommitLog åªèƒ½å•çº¿ç¨‹æ“ä½œï¼Œå†™ä¹‹å‰è¦å…ˆè·å–ä¸€ä¸ªé”ï¼Œè¿™ä¸ªé”ä¹Ÿå°±æ˜¯å½±å“ RocketMQ æ€§èƒ½æœ€å…³é”®çš„ä¸€ä¸ªé”ã€‚</p><p>ç†è®ºä¸Šè¿™é‡Œåªè¦å¾€ MappedByteBuffer å†™ä¸€ä¸‹å°±å¥½äº†ï¼Œä½†å®è·µå¾€å¾€è¦æ¯”ç†è®ºå¤æ‚å¾—å¤šï¼Œå› ä¸ºå„ç§åŸå› ï¼Œè¿™ä¸ªé”é‡Œé¢å¹²çš„äº‹æƒ…éå¸¸çš„å¤šã€‚</p><p>ç”±äºå½“å‰ä»£ç çš„å¤æ‚æ€§ï¼Œè¿™ä¸ªä¼˜åŒ–æ˜¯æœ¬æ‰¹æ¬¡ä¿®æ”¹é‡Œé¢æ”¹åŠ¨æœ€å¤§çš„ï¼Œä½†å®ƒçš„é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠé”å†…å¹²çš„äº‹æƒ…ï¼Œå°½é‡çš„æ”¾åˆ°é”çš„å¤–é¢å»åšï¼Œèƒ½å…ˆå‡†å¤‡å¥½çš„æ•°æ®å°±å…ˆå‡†å¤‡å¥½ã€‚å®ƒåŒ…æ‹¬äº†ä»¥ä¸‹æ”¹åŠ¨ï¼š</p><ol><li>å°† Buffer çš„å¤§éƒ¨åˆ†å‡†å¤‡å·¥ä½œï¼ˆç¼–ç å·¥ä½œï¼‰æ”¾åˆ°äº†é”å¤–ï¼Œæå‰åšå¥½ã€‚</li><li>å°† MessageId çš„åšæˆäº†æ‡’åˆå§‹åŒ–ï¼ˆæ”¾åˆ°é”å¤–ï¼‰ï¼Œè¿™ä¸ªæ¶ˆæ¯ ID çš„ç”Ÿæˆæ¶‰åŠå¾ˆå¤šç¼–è§£ç å’Œæ•°æ®å¤åˆ¶å·¥ä½œï¼Œå®é™…ä¸Šæ€§èƒ½å¼€é”€ç›¸å½“å¤§ã€‚</li><li>åŸæ¥é”å†…ç”¨æ¥æŸ¥ä½ç‚¹å“ˆå¸Œè¡¨çš„ Key æ˜¯ä¸ªæ‹¼æ¥å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œè¿™æ¬¡ä¹Ÿæ”¹åˆ°é”å¤–å…ˆç”Ÿæˆå¥½ã€‚</li><li>é¡ºä¾¿è¡¥ä¸Šäº†ä¹‹å‰é—æ¼çš„å…³äº IPv6 çš„å¤„ç†ã€‚</li><li>åˆ é™¤äº†æ— ç”¨çš„ä»£ç ã€‚</li></ol><hr><h4 id="ä¼˜åŒ–-asyncputmessage-æ€§èƒ½-å°†å‡†å¤‡å·¥ä½œæ”¾åˆ°é”å¤–" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–-asyncputmessage-æ€§èƒ½-å°†å‡†å¤‡å·¥ä½œæ”¾åˆ°é”å¤–" aria-hidden="true">#</a> ä¼˜åŒ– asyncPutMessage æ€§èƒ½ï¼Œå°†å‡†å¤‡å·¥ä½œæ”¾åˆ°é”å¤–</h4><p>å…ˆçœ‹ä¸€ä¸‹ä»£ç ä¸Šçš„æ”¹åŠ¨ï¼Œå³è¾¹ç»¿è‰²æ–°å¢çš„ä»£ç æ˜¯åŸå…ˆåœ¨é”ä¸­çš„æ“ä½œï¼Œç°åœ¨éƒ½ç§»åŠ¨åˆ°äº†é”å¤–é¢ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215547.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>å³è¾¹æ–°å¢çš„çš„ <code>putMessageThreadLocal.getEncode().encode(msg)</code> å®Œæˆäº†å¤§é‡é¢„æ“ä½œï¼Œå°†åŸå…ˆ <code>CommitLog#DefaultAppendMessageCallback#doAppend()</code> æ–¹æ³•ä¸­çš„æ“ä½œç§»åŠ¨åˆ°äº†é”å¤–ã€‚</p><p>ä¸‹é¢çš„ä»£ç ç¬¬ä¸€ä»½æ˜¯ä¿®æ”¹å‰çš„ï¼ŒdoAppend() æ–¹æ³•æ˜¯é”å†…æ“ä½œï¼›ç¬¬äºŒä»½æ˜¯ä¿®æ”¹åçš„ï¼Œencode() æ–¹æ³•æŠ½åˆ°äº†åŠ é”ä¹‹å‰ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// CommitLog.java ä¿®æ”¹å‰</span>
<span class="token keyword">public</span> <span class="token class-name">AppendMessageResult</span> <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> fileFromOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxBlank<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">MessageExtBrokerInner</span> msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token doc-comment comment">/**
     * Serialize message
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertiesData <span class="token operator">=</span>
        msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> propertiesLength <span class="token operator">=</span> propertiesData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">&gt;</span> <span class="token class-name">Short</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;putMessage message properties length too long. length={}&quot;</span><span class="token punctuation">,</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span><span class="token class-name">AppendMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PROPERTIES_SIZE_EXCEEDED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topicData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> topicData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> bodyLength <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> msgLen <span class="token operator">=</span> <span class="token function">calMsgLength</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bodyLength<span class="token punctuation">,</span> topicLength<span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Exceeds the maximum message</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgLen <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommitLog</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;message size exceeded, msg total size: &quot;</span> <span class="token operator">+</span> msgLen <span class="token operator">+</span> <span class="token string">&quot;, msg body size: &quot;</span> <span class="token operator">+</span> bodyLength
            <span class="token operator">+</span> <span class="token string">&quot;, maxMessageSize: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span><span class="token class-name">AppendMessageStatus</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_SIZE_EXCEEDED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... Determines whether there is sufficient free space</span>

		<span class="token comment">// Initialization of storage space</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>msgStoreItemMemory<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 1 TOTALSIZE</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2 MAGICCODE</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token class-name">CommitLog</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_MAGIC_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3 BODYCRC</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBodyCRC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4 QUEUEID</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5 FLAG</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6 QUEUEOFFSET</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 7 PHYSICALOFFSET</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 8 SYSFLAG</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 9 BORNTIMESTAMP</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 10 BORNHOST</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>bornHostHolder<span class="token punctuation">,</span> bornHostLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornHostBytes</span><span class="token punctuation">(</span>bornHostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 11 STORETIMESTAMP</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 12 STOREHOSTADDRESS</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>storeHostHolder<span class="token punctuation">,</span> storeHostLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreHostBytes</span><span class="token punctuation">(</span>storeHostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 13 RECONSUMETIMES</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 14 Prepared Transaction Offset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getPreparedTransactionOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 15 BODY</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 16 TOPIC</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 17 PROPERTIES</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propertiesData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// CommitLog.java ä¿®æ”¹å</span>
<span class="token keyword">protected</span> <span class="token class-name">PutMessageResult</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * Serialize message
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertiesData <span class="token operator">=</span>
            msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> propertiesLength <span class="token operator">=</span> propertiesData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">&gt;</span> <span class="token class-name">Short</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;putMessage message properties length too long. length={}&quot;</span><span class="token punctuation">,</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageResult</span><span class="token punctuation">(</span><span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PROPERTIES_SIZE_EXCEEDED</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topicData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> topicData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> bodyLength <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> msgLen <span class="token operator">=</span> <span class="token function">calMsgLength</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bodyLength<span class="token punctuation">,</span> topicLength<span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Exceeds the maximum message</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgLen <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommitLog</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;message size exceeded, msg total size: &quot;</span> <span class="token operator">+</span> msgLen <span class="token operator">+</span> <span class="token string">&quot;, msg body size: &quot;</span> <span class="token operator">+</span> bodyLength
                <span class="token operator">+</span> <span class="token string">&quot;, maxMessageSize: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageResult</span><span class="token punctuation">(</span><span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_ILLEGAL</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Initialization of storage space</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>encoderBuffer<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1 TOTALSIZE</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2 MAGICCODE</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token class-name">CommitLog</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_MAGIC_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3 BODYCRC</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBodyCRC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4 QUEUEID</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5 FLAG</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6 QUEUEOFFSET, need update later</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 7 PHYSICALOFFSET, need update later</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 8 SYSFLAG</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 9 BORNTIMESTAMP</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 10 BORNHOST</span>
            <span class="token function">socketAddress2ByteBuffer</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 11 STORETIMESTAMP</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 12 STOREHOSTADDRESS</span>
            <span class="token function">socketAddress2ByteBuffer</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 13 RECONSUMETIMES</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 14 Prepared Transaction Offset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getPreparedTransactionOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 15 BODY</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 16 TOPIC</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 17 PROPERTIES</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>encoderBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propertiesData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            encoderBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæŠŠé¢„ç¼–ç çš„æ•°æ®æ”¾åˆ° <code>MessageExtBrokerInner</code> ä¸­çš„ <code>private ByteBuffer encodedBuff</code> å­—æ®µï¼Œä¼ åˆ° <code>doAppend()</code> æ–¹æ³•ä¸­ä½¿ç”¨</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215548.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><h4 id="messageid-æ‡’åŠ è½½" tabindex="-1"><a class="header-anchor" href="#messageid-æ‡’åŠ è½½" aria-hidden="true">#</a> <strong>MessageId æ‡’åŠ è½½</strong></h4><p>ä½¿ç”¨å‡½æ•°å¼æ¥å£ <code>Supplier</code>ï¼Œå°† MessageId è®¡ç®—çš„é€»è¾‘æ”¾åˆ° <code>Supplier</code> ä¸­ã€‚åˆ›å»ºç»“æœå¯¹è±¡æ—¶å°† <code>Supplier</code> ä¼ å…¥ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¡ç®— MessageIdã€‚</p><p>å½“ç»“æœçš„ <code>getMsgId()</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œæ‰ä¼šæ‰§è¡Œ <code>Supplier</code> ä¸­ MessageId çš„è®¡ç®—æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// CommitLog#DefaultAppendMessageCallback</span>
<span class="token keyword">public</span> <span class="token class-name">AppendMessageResult</span> <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> fileFromOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxBlank<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageExtBrokerInner</span> msgInner<span class="token punctuation">,</span> <span class="token class-name">PutMessageContext</span> putMessageContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;</span>

    <span class="token comment">// PHY OFFSET</span>
    <span class="token keyword">long</span> wroteOffset <span class="token operator">=</span> fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> msgIdSupplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sysflag <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> msgIdLen <span class="token operator">=</span> <span class="token punctuation">(</span>sysflag <span class="token operator">&amp;</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">STOREHOSTADDRESS_V6_FLAG</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">:</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> msgIdBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>msgIdLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageExt</span><span class="token punctuation">.</span><span class="token function">socketAddress2ByteBuffer</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgIdBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgIdBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//because socketAddress2ByteBuffer flip the buffer</span>
        msgIdBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgIdLen <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">,</span> wroteOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">bytes2string</span><span class="token punctuation">(</span>msgIdBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">AppendMessageResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span><span class="token class-name">AppendMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span><span class="token punctuation">,</span> wroteOffset<span class="token punctuation">,</span> msgLen<span class="token punctuation">,</span> msgIdSupplier<span class="token punctuation">,</span>
                msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> <span class="token class-name">CommitLog</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AppendMessageResult.java</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// msgIdæ‡’åŠ è½½</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msgIdSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgId <span class="token operator">=</span> msgIdSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> msgId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¼˜åŒ–æ¶ˆæ¯-header-è§£æçš„æ€§èƒ½-13-15" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–æ¶ˆæ¯-header-è§£æçš„æ€§èƒ½-13-15" aria-hidden="true">#</a> ä¼˜åŒ–<strong>æ¶ˆæ¯ Header è§£æçš„æ€§èƒ½ï¼ˆ13-15ï¼‰</strong></h3><h4 id="å»é™¤å­—ç¬¦ä¸²æœ«å°¾å ä½ç¬¦-èŠ‚çœæ¶ˆæ¯ä¼ è¾“å¤§å°" tabindex="-1"><a class="header-anchor" href="#å»é™¤å­—ç¬¦ä¸²æœ«å°¾å ä½ç¬¦-èŠ‚çœæ¶ˆæ¯ä¼ è¾“å¤§å°" aria-hidden="true">#</a> å»é™¤å­—ç¬¦ä¸²æœ«å°¾å ä½ç¬¦ï¼ŒèŠ‚çœæ¶ˆæ¯ä¼ è¾“å¤§å°</h4><p>ä¼˜åŒ–å­—ç¬¦ä¸²æ ¼å¼çš„å±æ€§å­˜å‚¨ã€‚RocketMQ åœ¨æ¶ˆæ¯ä¼ è¾“æ—¶ç”¨å­—ç¬¦ä¸²å­˜å‚¨ä¸€ä¸ª Mapï¼Œæ¥å—æ¶ˆæ¯åå†è§£ææˆMapã€‚</p><p>å­—ç¬¦ä¸²é‡‡ç”¨è¿™ç§æ ¼å¼å­˜å‚¨ Mapï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>key1\u0001value1\u0002key2\u0001value2\u0002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215549.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>è¯¥ Patch ä¼˜åŒ–æ‰äº†å­—ç¬¦ä¸²æœ«å°¾çš„<code>\u0002</code>ï¼Œä¸ºæ¯ä¸ªæ¶ˆæ¯èŠ‚çœäº†1å­—èŠ‚ä¼ è¾“å¤§å°ã€‚</p><hr><h4 id="ä¼˜åŒ–-string-å’Œ-map-äº’ç›¸è§£æçš„æ€§èƒ½" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–-string-å’Œ-map-äº’ç›¸è§£æçš„æ€§èƒ½" aria-hidden="true">#</a> ä¼˜åŒ– string å’Œ map äº’ç›¸è§£æçš„æ€§èƒ½</h4><p>ä¼˜åŒ–å‰åæ•ˆæœï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Benchmark</span>                               <span class="token class-name">Mode</span>  <span class="token class-name">Cnt</span>     <span class="token class-name">Score</span>   <span class="token class-name">Error</span>  <span class="token class-name">Units</span><span class="token punctuation">(</span><span class="token number">10000</span> loop in each op<span class="token punctuation">)</span>
<span class="token class-name">TempTest</span><span class="token punctuation">.</span>messageProperties2String      thrpt    <span class="token number">2</span>  <span class="token number">2257.276</span>          ops<span class="token operator">/</span>s
<span class="token class-name">TempTest</span><span class="token punctuation">.</span>messageProperties2String_old  thrpt    <span class="token number">2</span>  <span class="token number">1464.342</span>          ops<span class="token operator">/</span>s
<span class="token class-name">TempTest</span><span class="token punctuation">.</span>string2messageProperties      thrpt    <span class="token number">2</span>  <span class="token number">1590.499</span>          ops<span class="token operator">/</span>s
<span class="token class-name">TempTest</span><span class="token punctuation">.</span>string2messageProperties_old  thrpt    <span class="token number">2</span>   <span class="token number">605.118</span>          ops<span class="token operator">/</span>s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215550.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><hr><ul><li>string è½¬ map ä¼˜åŒ–</li></ul><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215551.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>ä¼˜åŒ–ç‚¹ä¸»è¦æ˜¯é¢„å…ˆè®¡ç®—äº†éœ€è¦è§£ææˆå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç„¶åä¸º <code>StringBuilder</code> å®šä¹‰äº†åˆå§‹é•¿åº¦ã€‚</p><p>StringBuilder æ˜¯ä¸€ä¸ªå¯ä»¥åŠ¨æ€å¢åŠ è‡ªèº«æ•°æ®é•¿åº¦çš„ç±»ï¼Œå…¶é»˜è®¤é•¿åº¦ï¼ˆcapacityå±æ€§ï¼‰ä¸º16ã€‚å®ƒçš„åº•å±‚ç»“æ„å®é™…æ˜¯ char[]ã€‚</p><p>åœ¨ TPS å¾ˆé«˜çš„åœºæ™¯ä¸‹ï¼Œ StringBuilder é»˜è®¤é•¿åº¦æ˜¯ 16ï¼Œå¤„ç†ä¸€ä¸ªæ­£å¸¸çš„æ¶ˆæ¯ï¼Œè‡³å°‘ä¼šå†…éƒ¨æ‰©å±• 2 æ¬¡ï¼Œç™½ç™½äº§ç”Ÿ 2 ä¸ªå¯¹è±¡å’Œ 2 æ¬¡æ•°ç»„å¤åˆ¶ã€‚</p><p>æ‰€ä»¥ä¼˜åŒ–æ–¹æ¡ˆå°±æ˜¯å…ˆç®—å¥½éœ€è¦çš„é•¿åº¦ï¼Œåˆ›å»º StringBuffer çš„æ—¶å€™ç›´æ¥å°±æŒ‡å®šå¥½ã€‚</p><hr><ul><li><strong>map è½¬ string ä¼˜åŒ–</strong></li></ul><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202203152215552.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>å¯ä»¥çœ‹åˆ°å³è¾¹çš„ä»£ç ä½¿ç”¨äº† <code>indexOf</code> å’Œ <code>substring</code> æ–¹æ³•æ›¿æ¢åŸæ¥çš„ <code>split</code> æ–¹æ³•</p><p>å…¶å® split æ–¹æ³•å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨ indexOf å’Œ substring æ–¹æ³•çš„ï¼Œä½†å®ƒå†…éƒ¨æ–°å»ºäº†ä¸€ä¸ª <code>ArrayList&lt;String&gt;</code> ç”¨æ¥ä¿å­˜è¿”å›ç»“æœï¼Œåœ¨è¿”å›æ—¶å°†ç»“æœå¤åˆ¶åˆ° String[]ã€‚</p><p>å³è¾¹æ–¹æ³•å°†åˆ‡åˆ†åçš„å­—ç¬¦ä¸²ç›´æ¥å­˜åˆ° map ä¸­ï¼Œå…å»äº†å­˜åˆ° <code>ArrayList&lt;String&gt;</code> ä¸­çš„è¿‡ç¨‹ï¼Œå‡å°‘äº†å¤åˆ¶ï¼Œä¹Ÿé¿å…äº† ArrayList æ‰©å®¹çš„æŸè€—ã€‚</p><h4 id="ä¼˜åŒ–-broker-è¯·æ±‚æ¶ˆæ¯å¤´è§£ç æ€§èƒ½-15" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–-broker-è¯·æ±‚æ¶ˆæ¯å¤´è§£ç æ€§èƒ½-15" aria-hidden="true">#</a> ä¼˜åŒ– Broker è¯·æ±‚æ¶ˆæ¯å¤´è§£ç æ€§èƒ½ï¼ˆ15ï¼‰</h4><blockquote><ol start="15"><li>Optimise parse performance for SendMessageRequestHeaderV2</li></ol></blockquote><p>RocketMQ çš„é€šä¿¡åè®®å®šä¹‰äº†å„ç§æŒ‡ä»¤ï¼Œå®ƒä»¬çš„ Header å„ä¸ç›¸åŒï¼Œå…±ç”¨äº†ä¸€ä¸ªé€šç”¨çš„è§£ææ–¹æ³•ï¼ŒåŸºäºåå°„æ¥è§£æå’Œè®¾ç½®æ¶ˆæ¯ Headerã€‚</p><p>è¿™ä¸ªè§£æ Header æ–¹æ³•çš„æ•ˆç‡å¾ˆä½ï¼Œæœ¬æ¬¡ä¼˜åŒ–å•ç‹¬å®šä¹‰äº†è§£æå‘é€æ¶ˆæ¯è¯·æ±‚å¤´çš„æ–¹æ³•ï¼Œç›´æ¥get Map ä¸­çš„å±æ€§ï¼Œæå‡æ•ˆç‡ã€‚</p><hr><p>å‘é€æ¶ˆæ¯çš„è¯·æ±‚headerä¼šç±»ä¼¼å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span>  
    <span class="token string">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">310</span><span class="token punctuation">,</span>
    <span class="token string">&quot;extFields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>  
        <span class="token string">&quot;f&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;g&quot;</span><span class="token operator">:</span><span class="token string">&quot;1482158310125&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;d&quot;</span><span class="token operator">:</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;e&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;b&quot;</span><span class="token operator">:</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;c&quot;</span><span class="token operator">:</span><span class="token string">&quot;TBW102&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;a&quot;</span><span class="token operator">:</span><span class="token string">&quot;please_rename_unique_group_name&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;j&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;k&quot;</span><span class="token operator">:</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;h&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;i&quot;</span><span class="token operator">:</span><span class="token string">&quot;TAGS\u0001TagA\u0002WAIT\u0001true\u0002&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;flag&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">&quot;language&quot;</span><span class="token operator">:</span><span class="token string">&quot;JAVA&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;opaque&quot;</span><span class="token operator">:</span><span class="token number">206</span><span class="token punctuation">,</span>
    <span class="token string">&quot;version&quot;</span><span class="token operator">:</span><span class="token number">79</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageRequestHeaderV2</span> <span class="token keyword">implements</span> <span class="token class-name">CommandCustomHeader</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> a<span class="token punctuation">;</span> <span class="token comment">// producerGroup;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> b<span class="token punctuation">;</span> <span class="token comment">// topic;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> c<span class="token punctuation">;</span> <span class="token comment">// defaultTopic;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> d<span class="token punctuation">;</span> <span class="token comment">// defaultTopicQueueNums;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> e<span class="token punctuation">;</span> <span class="token comment">// queueId;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> f<span class="token punctuation">;</span> <span class="token comment">// sysFlag;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> g<span class="token punctuation">;</span> <span class="token comment">// bornTimestamp;</span>
    <span class="token annotation punctuation">@CFNotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> h<span class="token punctuation">;</span> <span class="token comment">// flag;</span>
    <span class="token annotation punctuation">@CFNullable</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> i<span class="token punctuation">;</span> <span class="token comment">// properties;</span>
    <span class="token annotation punctuation">@CFNullable</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> j<span class="token punctuation">;</span> <span class="token comment">// reconsumeTimes;</span>
    <span class="token annotation punctuation">@CFNullable</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> k<span class="token punctuation">;</span> <span class="token comment">// unitMode = false;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> l<span class="token punctuation">;</span> <span class="token comment">// consumeRetryTimes</span>
    <span class="token annotation punctuation">@CFNullable</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> m<span class="token punctuation">;</span> <span class="token comment">//batch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œä¼šå°† Header è§£ç æˆ <code>SendMessageRequestHeaderV2</code> ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CommandCustomHeader</span> <span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CommandCustomHeader</span><span class="token punctuation">&gt;</span></span> classHeader<span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CommandCustomHeader</span> objectHeader<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        objectHeader <span class="token operator">=</span> classHeader<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>extFields <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> <span class="token function">getClazzFields</span><span class="token punctuation">(</span>classHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> fieldName <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fieldName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>extFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Annotation</span> annotation <span class="token operator">=</span> <span class="token function">getNotNullAnnotation</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemotingCommandException</span><span class="token punctuation">(</span><span class="token string">&quot;the custom field &lt;&quot;</span> <span class="token operator">+</span> fieldName <span class="token operator">+</span> <span class="token string">&quot;&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> type <span class="token operator">=</span> <span class="token function">getCanonicalName</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Object</span> valueParsed<span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">StringCanonicalName</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            valueParsed <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">IntegerCanonicalName1</span><span class="token punctuation">)</span> <span class="token operator">||</span> type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">IntegerCanonicalName2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            valueParsed <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">LongCanonicalName1</span><span class="token punctuation">)</span> <span class="token operator">||</span> type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">LongCanonicalName2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            valueParsed <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">BooleanCanonicalName1</span><span class="token punctuation">)</span> <span class="token operator">||</span> type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">BooleanCanonicalName2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            valueParsed <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">DoubleCanonicalName1</span><span class="token punctuation">)</span> <span class="token operator">||</span> type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">DoubleCanonicalName2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            valueParsed <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemotingCommandException</span><span class="token punctuation">(</span><span class="token string">&quot;the custom field &lt;&quot;</span> <span class="token operator">+</span> fieldName <span class="token operator">+</span> <span class="token string">&quot;&gt; type is not supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectHeader<span class="token punctuation">,</span> valueParsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        objectHeader<span class="token punctuation">.</span><span class="token function">checkFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> objectHeader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">SendMessageRequestHeaderV2</span> <span class="token function">decodeSendMessageHeaderV2</span><span class="token punctuation">(</span>
        <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SendMessageRequestHeaderV2</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessageRequestHeaderV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fields <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getExtFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fields <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemotingCommandException</span><span class="token punctuation">(</span><span class="token string">&quot;the ext fields is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;a&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setA</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;b&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setB</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;c&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setC</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;d&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setD</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;e&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setE</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;f&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;f&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setF</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;g&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;g&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setG</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;the custom field &lt;h&gt; is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setH</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setI</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;j&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setJ</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;k&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setK</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setL</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setM</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å·¦è¾¹å…¶å®æ˜¯ä¸€ä¸ªé€šç”¨çš„è§£ç æ–¹æ³•ï¼Œå³è¾¹æ˜¯é’ˆå¯¹æ¶ˆæ¯ç”Ÿäº§çš„æŒ‡ä»¤ <code>SendMessageRequestHeaderV2</code> ä¼˜åŒ–çš„è§£ç æ–¹æ³•ã€‚è¿™é‡Œä¸å†ä½¿ç”¨å…±åŒçš„è¿™ä¸ªè§£æå™¨ï¼Œè€Œæ˜¯ç®€å•ç²—æš´çš„ç›´æ¥ä¸€ä¸ªä¸€ä¸ªå» set æ¯ä¸€ä¸ªå±æ€§ï¼Œè¿™æ ·è¿™ä¸ªæ–¹æ³•è·å¾—äº†å¤§çº¦ 4 å€æ€§èƒ½çš„æå‡ã€‚</p><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://mp.weixin.qq.com/s/40nyc_5YdI0D48HHE91FLA" target="_blank" rel="noopener noreferrer">Apache RocketMQ 4.9.1 é«˜æ€§èƒ½ä¼˜åŒ–ä¹‹è·¯<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://mp.weixin.qq.com/s/8Ok_B0gePQtZA8p97NRnRA" target="_blank" rel="noopener noreferrer">RocketMQè¿™æ ·åšï¼Œç¦»ç‰©ç†æé™æ€§èƒ½è¿˜å·®å¤šè¿œï¼Ÿ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://segmentfault.com/a/1190000016901608" target="_blank" rel="noopener noreferrer">å¯»æ‰¾Javaä¸­String.splitæ€§èƒ½æ›´å¥½çš„æ–¹æ³•<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://jaskey.github.io/blog/2016/12/19/rocketmq-network-protocol/" target="_blank" rel="noopener noreferrer">RocketMQâ€”â€”é€šä¿¡åè®®<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>æ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€æ¶ˆæ¯ä¸­é—´ä»¶ã€‘ï¼ˆmiddleware-mqï¼‰ï¼Œæ›´æ–°æ¶ˆæ¯ä¸­é—´ä»¶çš„æºç è§£æå’Œæœ€æ–°åŠ¨æ€ï¼</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/src/rocketmq/20220131-rocketmq-4.9.1-performance-improvement.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2023 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-eaa093f0.js" defer></script>
  </body>
</html>
